<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ¿ Comba Watch Party Ultimate</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <!-- YouTube Senkronize OynatÄ±cÄ± Ä°Ã§in -->
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
        :root { 
            --primary: #e50914; --primary-hover: #b20710; --bg-color: #0f0f0f; --card-bg: #1e1e1e; --text-color: #f1f1f1; --border-color: #333; 
            --layout-dir: row;
            --chat-width: 350px;
            --video-scale: 1;
        }
        
        body.theme-cyberpunk { --primary: #ff00ff; --primary-hover: #d600d6; --bg-color: #080014; --card-bg: #120024; --border-color: #00ffff; --text-color: #e0e0ff; }
        body.theme-derbi { --primary: #ffffff; --primary-hover: #e0e0e0; --bg-color: #0b1f0d; --card-bg: #123316; --border-color: #4CAF50; --text-color: #ffffff; }
        body.theme-cinema { --primary: #f5c518; --primary-hover: #d4a715; --bg-color: #000000; --card-bg: #0a0a0a; --border-color: #332900; --text-color: #eaeaea; }

        body { margin: 0; font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; background-color: var(--bg-color); color: var(--text-color); overflow-x: hidden; transition: background-color 0.5s, color 0.5s; }
        * { box-sizing: border-box; }
        .screen { display: none; }
        .screen.active { display: flex; }
        
        button, a, .reaction-btn, #ptt-btn-mobile { -webkit-tap-highlight-color: transparent; outline: none; }
        .hide-on-desktop { display: none !important; }

        /* Toast Bildirimleri */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 999999; display: flex; flex-direction: column; gap: 10px; pointer-events: none;}
        .toast { background: #2a2a2a; color: #fff; padding: 12px 18px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.6); border-left: 4px solid var(--primary); font-size: 0.9rem; font-weight: 500; transform: translateX(120%); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: flex; align-items: center; gap: 10px; max-width: 300px; pointer-events: auto;}
        .toast.show { transform: translateX(0); }
        .toast.success { border-left-color: #4CAF50; }
        .toast.error { border-left-color: #f44336; }
        .toast.info { border-left-color: #2196F3; }
        
        /* Modallar Genel */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 99999; padding: 20px; backdrop-filter: blur(5px);}
        .modal-overlay.active { display: flex; }
        .modal { background: var(--card-bg); padding: 25px; border-radius: 12px; width: 100%; max-width: 420px; box-shadow: 0 10px 40px rgba(0,0,0,0.8); max-height: 90vh; overflow-y: auto; transition: background-color 0.5s; border: 1px solid var(--border-color); }
        .modal h2 { margin-top: 0; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; font-size: 1.2rem; display: flex; justify-content: space-between; align-items: center; }
        .modal-close { width: 100%; padding: 12px; background: var(--primary); color: #000; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 10px; transition: background-color 0.3s; }
        body:not(.theme-derbi) .modal-close { color: white; }

        .setting-group { margin-bottom: 15px; background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); }
        .setting-group label { display: block; margin-bottom: 8px; color: #aaa; font-size: 0.85rem; font-weight: bold; text-transform: uppercase; }
        .setting-group select, .setting-group input[type="range"], .setting-group input[type="text"] { width: 100%; padding: 10px; border-radius: 6px; background: rgba(0,0,0,0.5); border: 1px solid var(--border-color); color: white; outline: none; }
        .avatar-selector { display: flex; gap: 8px; flex-wrap: wrap; align-items: center;}
        .avatar-option { width: 45px; height: 45px; display: flex; justify-content: center; align-items: center; font-size: 1.5rem; cursor: pointer; border-radius: 50%; border: 2px solid transparent; transition: 0.2s; background: rgba(0,0,0,0.5); overflow: hidden;}
        .avatar-option img { width: 100%; height: 100%; object-fit: cover; }
        .avatar-option.selected { border-color: var(--primary); transform: scale(1.15); box-shadow: 0 0 10px var(--primary);}
        .custom-file-upload { font-size: 0.8rem; padding: 8px 12px; background: #333; color: white; border-radius: 20px; cursor: pointer; border: 1px solid #555; display: inline-block; }
        .custom-file-upload:hover { background: #444; }

        /* INBOX & DESTEK MODALI Ã–ZEL */
        .tabs { display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .tabs button { flex: 1; padding: 10px; background: transparent; border: none; color: #888; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .tabs button.active { color: var(--primary); border-bottom: 2px solid var(--primary); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .ticket-item { background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px; margin-bottom: 10px; border: 1px solid var(--border-color); font-size: 0.85rem; line-height: 1.4; display:flex; justify-content:space-between; align-items:center; }
        .ticket-item input { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--border-color); background: rgba(0,0,0,0.5); color: white; margin: 8px 0; outline:none; }
        .friend-btn { background: var(--primary); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.75rem; font-weight: bold;}
        body.theme-derbi .friend-btn { color: #000; }

        /* BÄ°REYSEL KULLANICI MODALI */
        .user-action-header { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .user-action-avatar { width: 60px; height: 60px; border-radius: 50%; background: #333; display: flex; justify-content: center; align-items: center; font-size: 2rem; overflow: hidden; border: 2px solid var(--primary);}
        .user-action-avatar img { width: 100%; height: 100%; object-fit: cover; }

        /* GiriÅŸ EkranÄ± */
        #login-screen { height: 100vh; justify-content: center; align-items: center; padding: 20px; flex-direction: column; gap: 20px;}
        .card { background: var(--card-bg); padding: 35px; border-radius: 16px; text-align: center; width: 100%; max-width: 400px; box-shadow: 0 15px 50px rgba(0,0,0,0.6); border: 1px solid var(--border-color); transition: background-color 0.5s, border-color 0.5s; }
        .card h1 { margin-top: 0; color: var(--primary); font-size: 2rem; margin-bottom: 5px; }
        .card p { color: #888; margin-bottom: 25px; font-size: 0.9rem; }
        .card input { width: 100%; padding: 14px; margin: 8px 0; border: 1px solid var(--border-color); border-radius: 8px; background: rgba(0,0,0,0.5); color: white; font-size: 1rem; text-align: center; outline: none; transition: 0.2s; }
        .card input:focus { border-color: var(--primary); }
        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        .card button { flex: 1; padding: 14px; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; transition: background-color 0.3s; }
        
        #btn-host-screen { background: var(--primary); color: #000; } #btn-host-screen:hover { background: var(--primary-hover); }
        body:not(.theme-derbi) #btn-host-screen { color: white; }
        #btn-host-sync-menu { background: #E53935; color: white; } #btn-host-sync-menu:hover { background: #D32F2F; }
        #btn-viewer { background: #2196F3; } #btn-viewer:hover { background: #1976D2; }
        .extra-btn { background: #333; width: 100%; margin-top: 10px; display:flex; justify-content:center; align-items:center; gap:5px; }
        #mobile-host-warning { display: none; color: #ffeb3b; font-size: 0.8rem; margin-top: 15px; padding: 10px; background: rgba(255, 235, 59, 0.1); border-radius: 6px; border: 1px solid rgba(255, 235, 59, 0.3); }

        /* Ana Ekran DÃ¼zeni */
        .main-container { display: flex; width: 100vw; height: 100vh; transition: 0.3s; flex-direction: var(--layout-dir); }
        .video-section { flex: 3; display: flex; flex-direction: column; background: #000; position: relative; transition: flex 0.3s, height 0.3s; }
        .header { background: var(--card-bg); padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); transition: background-color 0.5s, opacity 0.5s ease; }
        .header-left { display: flex; flex-direction: column; flex: 1; min-width: 0; }
        .header-left h2 { margin: 0; font-size: 1.1rem; color: var(--text-color); font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .header-controls { display: flex; gap: 8px; flex-wrap: wrap; position: relative; align-items: center; }
        
        .desktop-controls { display: flex; gap: 8px; flex-wrap: wrap; }
        
        .ctrl-btn { padding: 8px 12px; border: 1px solid transparent; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85rem; color: white; transition: 0.2s; display: flex; align-items: center; gap: 5px; }
        .ctrl-btn.theater { background: #0288d1; } .ctrl-btn.pip { background: #00796b; } .ctrl-btn.cinema { background: #673ab7; }
        .ctrl-btn.mic { background: #444; } .ctrl-btn.mic.active { background: var(--primary); animation: pulse 1.5s infinite; color: #000; }
        .ctrl-btn.camera { background: #8e24aa; } .ctrl-btn.camera.active { background: #e53935; animation: pulse 2s infinite; }
        .ctrl-btn.music { background: #00897b; } .ctrl-btn.music.active { background: #ffeb3b; color: #000 !important; box-shadow: 0 0 10px #ffeb3b; }
        body:not(.theme-derbi) .ctrl-btn.mic.active { color: white; }
        .ctrl-btn.speaker { background: #444; } .ctrl-btn.speaker.active { background: #ff9800; }
        .ctrl-btn.settings { background: #333; border-color: var(--border-color); } .ctrl-btn.leave { background: #2a2a2a; border: 1px solid #555; }
        .ctrl-btn:hover { filter: brightness(1.2); }

        .video-wrapper { flex: 1; position: relative; display: flex; justify-content: center; align-items: center; background: #000; overflow: hidden; }
        #main-video { width: 100%; height: 100%; object-fit: contain; max-height: calc(100vh - 65px); outline: none; transform: scale(var(--video-scale)); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        /* Senkronize Medya Container */
        #sync-media-container { display: none; position: absolute; inset: 0; width: 100%; height: 100%; background: #000; z-index: 5; }
        #sync-video { width: 100%; height: 100%; object-fit: contain; outline: none; }
        #yt-player { width: 100%; height: 100%; border: none; }
        
        .layout-resizer { width: 6px; background: transparent; cursor: col-resize; z-index: 50; transition: background 0.2s, opacity 0.5s ease; }
        .layout-resizer:hover, .layout-resizer.dragging { background: var(--primary); }

        /* KONUÅAN PARLAR AVATARLARI */
        #voice-avatars-container { position: absolute; top: 15px; left: 15px; display: flex; flex-wrap: wrap; gap: 12px; z-index: 90; }
        .v-avatar { width: 45px; height: 45px; border-radius: 50%; background: rgba(20,20,20,0.8); border: 2px solid #555; display: flex; justify-content: center; align-items: center; font-size: 1.5rem; transition: transform 0.1s, box-shadow 0.1s, border-color 0.1s; position: relative; backdrop-filter: blur(5px); cursor: pointer; overflow: hidden;}
        .v-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .v-avatar.speaking { border-color: #4CAF50; box-shadow: 0 0 15px rgba(76, 175, 80, 0.9); transform: translateY(-5px) scale(1.1); }
        .v-avatar .v-name { position: absolute; bottom: -20px; font-size: 0.7rem; background: rgba(0,0,0,0.8); color: white; padding: 2px 6px; border-radius: 4px; white-space: nowrap; font-weight: bold; border: 1px solid #444; }

        /* YÃœZEN REAKSÄ°YON KAMERALARI */
        .face-cam-bubble { position: absolute; top: 20px; right: 20px; width: 130px; height: 130px; border-radius: 50%; border: 3px solid var(--primary); overflow: hidden; box-shadow: 0 5px 20px rgba(0,0,0,0.8); z-index: 1000; cursor: grab; background: #000; transition: transform 0.2s ease-out; }
        .face-cam-bubble:active { cursor: grabbing; transform: scale(1.05); }
        .face-cam-bubble video { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }
        .face-cam-name { position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); font-size: 0.75rem; color: #fff; background: rgba(0,0,0,0.7); padding: 3px 8px; border-radius: 10px; font-weight: bold; pointer-events: none; white-space: nowrap; }

        #play-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.85); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 10; backdrop-filter: blur(5px); }
        #play-overlay h2 { color: var(--primary); font-size: 1.8rem; margin-bottom: 10px; }
        #play-overlay button { padding: 12px 35px; font-size: 1.1rem; background: var(--primary); color: #000; border: none; border-radius: 50px; cursor: pointer; margin-top: 15px; font-weight: bold; }
        body:not(.theme-derbi) #play-overlay button { color: white; }

        #admin-announcement-ui { display: none; position: absolute; top: 15%; left: 50%; transform: translateX(-50%); background: rgba(229, 9, 20, 0.95); padding: 25px 40px; border-radius: 12px; z-index: 99999; color: white; font-size: 2rem; font-weight: 900; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.8); border: 2px solid #fff; pointer-events: none; }

        /* ğŸ… MATTER.JS FÄ°ZÄ°KSEL EKRAN ETKÄ°LEÅÄ°M ALANI */
        #matter-canvas { position: absolute; inset: 0; width: 100%; height: 100%; pointer-events: none; z-index: 80; }

        .reaction-bar { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(20, 20, 20, 0.8); backdrop-filter: blur(10px); padding: 8px 15px; border-radius: 30px; display: flex; gap: 15px; z-index: 100; border: 1px solid var(--border-color); transition: opacity 0.5s ease; }
        .reaction-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; transition: transform 0.2s; padding: 0; user-select: none; touch-action: none; }
        .reaction-btn:hover { transform: scale(1.3); }
        
        .dragged-emoji { position: fixed; font-size: 2rem; pointer-events: none; z-index: 999999; transform: translate(-50%, -50%); text-shadow: 0 5px 15px rgba(0,0,0,0.5); }

        #floating-emoji-container { position: absolute; inset: 0; pointer-events: none; z-index: 99; overflow: hidden; }
        .floating-emoji { position: absolute; bottom: 50px; font-size: 2rem; opacity: 1; animation: floatUp 2.5s ease-out forwards; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        @keyframes floatUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 50% { transform: translateY(-150px) scale(1.5) translateX(20px); opacity: 0.8; } 100% { transform: translateY(-300px) scale(1); opacity: 0; } }

        @keyframes scare { 0% { filter: invert(1) hue-rotate(180deg); transform: translate(15px, -15px); } 10% { filter: invert(0); transform: translate(-15px, 15px); } 20% { filter: invert(1) hue-rotate(180deg); transform: translate(15px, 15px); } 30% { filter: invert(0); transform: translate(-15px, -15px); } 40% { filter: invert(1); transform: translate(0, 0); } }
        .jumpscare { animation: scare 0.1s infinite; } .jumpscare video { opacity: 0.3; }
        .confetti { position: fixed; top: -10px; width: 12px; height: 12px; z-index: 999999; animation: fall linear forwards; pointer-events: none; border-radius: 2px; }
        @keyframes fall { to { transform: translateY(110vh) rotate(720deg); } }

        /* Sohbet Paneli */
        .sidebar { flex: 1; background: var(--card-bg); border-left: 1px solid var(--border-color); display: flex; flex-direction: column; max-width: var(--chat-width); width: var(--chat-width); transition: opacity 0.5s ease; z-index: 40; }
        .sidebar-header { padding: 15px; background: rgba(0,0,0,0.3); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; cursor: grab; }
        .sidebar-header:active { cursor: grabbing; }
        .sidebar-header h3 { margin: 0; font-size: 1rem; color: var(--text-color); user-select: none; }
        
        .sidebar.floating { position: fixed !important; top: var(--float-top, 20px) !important; left: var(--float-left, 20px) !important; height: var(--float-height, 500px) !important; width: var(--chat-width, 320px) !important; max-width: 90vw !important; z-index: 10000; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.9); resize: both; overflow: hidden; border: 1px solid var(--border-color); }
        .sidebar.floating .sidebar-header { background: rgba(229, 9, 20, 0.2); }
        .sidebar.floating::before { content: "ğŸ“Œ Ã‡ift tÄ±kla sabitle"; position: absolute; top: 2px; left: 50%; transform: translateX(-50%); font-size: 0.6rem; color: #888; pointer-events: none; }

        .chat-messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; background: rgba(0,0,0,0.1); }
        .message { background: rgba(0,0,0,0.4); padding: 10px 12px; border-radius: 10px; font-size: 0.9rem; line-height: 1.4; align-self: flex-start; max-width: 85%; word-wrap: break-word; box-shadow: 0 2px 5px rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.05); }
        .message.me { background: rgba(var(--primary), 0.2); border-color: var(--primary); align-self: flex-end; border-bottom-right-radius: 2px; }
        .message.system { background: #333; color: #ffeb3b; align-self: center; text-align: center; border-radius: 20px; font-weight: bold; font-size: 0.8rem; }
        .message:not(.me):not(.system) { border-bottom-left-radius: 2px; }
        .message .sender-info { display: flex; align-items: center; gap: 6px; font-weight: 600; color: #aaa; font-size: 0.75rem; margin-bottom: 4px; cursor:pointer; transition: color 0.2s;}
        .message .sender-info:hover { color: var(--primary); }
        .message.me .sender-info { color: var(--text-color); cursor: default;}
        .msg-avatar { width: 20px; height: 20px; display: inline-block; border-radius: 50%; overflow: hidden; vertical-align: middle; text-align:center;}
        .msg-avatar img { width: 100%; height: 100%; object-fit: cover; }
        
        .chat-input-area { padding: 12px; background: rgba(0,0,0,0.3); border-top: 1px solid var(--border-color); display: flex; gap: 8px; }
        #chat-input { flex: 1; padding: 12px; border-radius: 20px; border: 1px solid var(--border-color); background: rgba(0,0,0,0.5); color: white; outline: none; font-size: 0.9rem; }
        #chat-send-btn { padding: 0 18px; background: var(--primary); color: #000; border: none; border-radius: 20px; cursor: pointer; font-weight: bold; }
        body:not(.theme-derbi) #chat-send-btn { color: white; }

        #admin-panel { display: none; background: rgba(0,0,0,0.4); border-top: 1px solid var(--border-color); padding: 15px; }
        #admin-panel h4 { margin: 0 0 10px 0; color: var(--primary); display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; text-transform: uppercase;}
        #btn-clear-chat { padding: 4px 10px; background: #444; border: none; color: white; border-radius: 4px; cursor: pointer; font-size: 0.75rem; }
        #admin-user-list { list-style: none; padding: 0; margin: 0; max-height: 100px; overflow-y: auto; }
        .admin-user-item { display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.5); padding: 8px 10px; margin-bottom: 5px; border-radius: 6px; font-size: 0.85rem; border: 1px solid var(--border-color); }
        .kick-btn { background: #e50914; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.75rem; font-weight: bold; }

        /* ğŸ§˜â€â™‚ï¸ AKILLI ZEN MODU */
        body.zen-mode .header, body.zen-mode .layout-resizer, body.zen-mode .reaction-bar, body.zen-mode #mobile-chat-bubble-btn { opacity: 0; pointer-events: none; transition: opacity 1.5s ease; }
        body.zen-mode .sidebar:not(.floating) { opacity: 0; pointer-events: none; transition: opacity 1.5s ease; }

        .main-container.theater-mode .sidebar { max-width: 0; opacity: 0; overflow: hidden; border: none; padding: 0; }
        body.cinema-mode .sidebar { display: none; }
        body.cinema-mode .header { display: none; }
        body.cinema-mode .video-section { position: fixed; inset: 0; z-index: 9999; background: #000; }
        body.cinema-mode #main-video, body.cinema-mode #sync-media-container { max-height: 100vh; transform: scale(1); }
        #btn-cinema-exit { display: none; position: fixed; top: 20px; right: 20px; z-index: 10000; background: rgba(229, 9, 20, 0.9); padding: 10px 20px; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: opacity 0.5s ease; }
        body.cinema-mode #btn-cinema-exit { display: block; }
        body.zen-mode #btn-cinema-exit { opacity: 0; pointer-events: none; }

        #ptt-btn-mobile { position: fixed; bottom: 80px; right: 20px; z-index: 99999; width: 70px; height: 70px; border-radius: 50%; background: rgba(229, 9, 20, 0.9); color: white; border: 3px solid #fff; font-size: 30px; display: none; justify-content: center; align-items: center; box-shadow: 0 5px 20px rgba(0,0,0,0.5); user-select: none; -webkit-user-select: none; transition: 0.2s; }
        #ptt-btn-mobile.talking { background: #4CAF50; transform: scale(1.1); box-shadow: 0 0 20px #4CAF50; }

        /* ğŸ’¬ Mobil Sohbet BaloncuÄŸu Butonu */
        #mobile-chat-bubble-btn { position: fixed; top: 70px; right: 15px; width: 50px; height: 50px; background: var(--primary); color: white; border-radius: 50%; display: none; justify-content: center; align-items: center; font-size: 1.5rem; z-index: 10001; box-shadow: 0 5px 20px rgba(0,0,0,0.6); border: 2px solid #fff; cursor: pointer; transition: opacity 0.5s ease, transform 0.2s; }
        #mobile-chat-bubble-btn:hover { transform: scale(1.1); }

        #wrapped-overlay { position: fixed; inset: 0; z-index: 9999999; background: linear-gradient(135deg, var(--bg-color), var(--primary)); display: none; flex-direction: column; justify-content: center; align-items: center; color: white; text-align: center; overflow: hidden; }
        .w-slide { position: absolute; opacity: 0; transform: translateY(50px); transition: all 0.8s ease-out; font-size: 1.8rem; width: 90%; max-width: 600px; }
        .w-slide.show { opacity: 1; transform: translateY(0); }
        .w-title { font-size: 2.5rem; font-weight: 900; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 2px; text-shadow: 2px 2px 10px rgba(0,0,0,0.5); }
        .w-highlight { color: #ffd700; font-size: 4.5rem; display: block; margin: 15px 0; font-weight: 900; text-shadow: 0 0 20px rgba(255, 215, 0, 0.5); }

        /* MOBÄ°L DÃœZENLEMELERÄ° (MENÃœ & SAÄ ÃœST SOHBET & DÃœZEN) */
        @media (max-width: 768px) {
            .hide-on-desktop { display: flex !important; align-items: center; justify-content: center; }
            .hide-on-mobile { display: none !important; }
            #btn-host-screen { display: none !important; } #mobile-host-warning { display: block; } 
            
            .main-container { flex-direction: column; height: 100dvh; overflow: hidden; } 
            .header { padding: 10px 12px; flex-direction: row; align-items: center; flex-wrap: nowrap; }
            .header-left h2 { font-size: 0.95rem; } .header-controls { gap: 4px; } .ctrl-btn { padding: 6px 10px; font-size: 1rem; }
            
            .desktop-controls { display: none; position: absolute; top: 55px; right: 10px; width: 220px; background: var(--card-bg); padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); flex-direction: column; box-shadow: 0 10px 30px rgba(0,0,0,0.9); z-index: 9999; }
            .desktop-controls.open { display: flex; } .desktop-controls .ctrl-btn { flex: none; justify-content: flex-start; margin-bottom: 5px; width: 100%; } 
            .video-section { flex: 0 0 45vh; height: 45vh; transition: flex 0.3s, height 0.3s; }
            body.chat-floating .video-section { flex: 1; height: auto; }
            .layout-resizer { display: none; } 
            .sidebar { display: flex; max-width: 100%; width: 100%; flex: 1; border-left: none; border-top: 1px solid var(--border-color); } 
            .sidebar.floating { position: fixed !important; top: auto !important; bottom: 0 !important; left: 0 !important; width: 100% !important; height: 60vh !important; border-radius: 20px 20px 0 0; border: 1px solid var(--border-color); border-bottom: none; box-shadow: 0 -10px 40px rgba(0,0,0,0.8); }
            body.chat-floating-minimized #mobile-chat-bubble-btn { display: flex; }
            body.chat-floating-minimized .sidebar.floating { display: none !important; }
            #btn-toggle-float-mobile { display: flex !important; } .sidebar.floating #btn-toggle-float-mobile { display: none !important; }
            #btn-close-floating-mobile { display: none !important; } .sidebar.floating #btn-close-floating-mobile { display: flex !important; }
            .chat-messages { padding: 10px; } .chat-input-area { padding: 10px; padding-bottom: max(10px, env(safe-area-inset-bottom)); } 
            #btn-theater { display: none; } #ptt-btn-mobile { bottom: 90px; }
            .reaction-bar { bottom: 10px; padding: 5px 10px; gap: 10px; } .reaction-btn { font-size: 1.2rem; }
        }
    </style>
</head>
<body>

    <audio id="lobby-audio" loop preload="auto">
        <source src="https://cdn.pixabay.com/download/audio/2022/05/27/audio_1808fbf07a.mp3?filename=lofi-study-112191.mp3" type="audio/mpeg">
    </audio>

    <div id="toast-container"></div>

    <!-- Mobil Sohbet BaloncuÄŸu -->
    <div id="mobile-chat-bubble-btn">ğŸ’¬</div>

    <!-- BÄ°REYSEL KULLANICI MODALI (Sesi KÄ±sma / ArkadaÅŸ Ekleme) -->
    <div class="modal-overlay" id="user-action-modal">
        <div class="modal" style="max-width: 350px;">
            <div class="user-action-header">
                <div class="user-action-avatar" id="ua-avatar">ğŸ‘¤</div>
                <div>
                    <h3 id="ua-name" style="margin: 0; color: var(--primary); font-size: 1.3rem;">KullanÄ±cÄ±</h3>
                    <span id="ua-role" style="font-size: 0.8rem; color: #888;">Ä°zleyici</span>
                </div>
            </div>
            
            <div class="setting-group" id="ua-volume-group">
                <label>ğŸšï¸ KullanÄ±cÄ± Ses Seviyesi</label>
                <div style="display:flex; align-items:center; gap:10px;">
                    <input type="range" id="ua-vol-slider" min="0" max="100" value="100">
                    <button id="ua-btn-mute" style="background:#444; color:white; border:none; padding:8px; border-radius:6px; cursor:pointer;">Sessiz</button>
                </div>
            </div>

            <button id="ua-btn-add-friend" class="extra-btn" style="background:#2196F3; border:none; margin-top:0; padding:12px; font-weight:bold;">ğŸ¤ ArkadaÅŸ Ekle</button>
            <button class="modal-close" onclick="document.getElementById('user-action-modal').classList.remove('active')">Kapat</button>
        </div>
    </div>

    <!-- SENKRONÄ°ZE MEDYA MODALI -->
    <div class="modal-overlay" id="sync-media-modal">
        <div class="modal">
            <h2>ğŸ¬ Senkronize Medya Kur</h2>
            <p style="font-size:0.85rem; color:#aaa; margin-bottom:15px;">Ekran paylaÅŸÄ±mÄ± yerine herkesin cihazÄ±nda kendi internetiyle aÃ§Ä±lacak bir YouTube veya MP4 linki yapÄ±ÅŸtÄ±rÄ±n. Kalite maksimumda kalÄ±r!</p>
            
            <input type="text" id="sync-url-input" placeholder="YouTube Linki veya .mp4 URL'si..." style="width:100%; padding:12px; border-radius:6px; background:rgba(0,0,0,0.5); border:1px solid var(--border-color); color:white; margin-bottom:15px; outline:none;">
            
            <div style="display:flex; gap:10px;">
                <button id="btn-start-sync" style="flex:1; background:var(--primary); color:#000; border:none; padding:12px; border-radius:6px; font-weight:bold; cursor:pointer;">â–¶ MedyayÄ± BaÅŸlat</button>
                <button id="btn-stop-sync" style="flex:1; background:#444; color:#fff; border:none; padding:12px; border-radius:6px; font-weight:bold; cursor:pointer; display:none;">â¹ Kapat & Ekrana DÃ¶n</button>
            </div>
            <button class="modal-close" onclick="document.getElementById('sync-media-modal').classList.remove('active')">Ä°ptal</button>
        </div>
    </div>

    <!-- INBOX VE DESTEK MODALI -->
    <div class="modal-overlay" id="inbox-modal">
        <div class="modal" style="max-width: 500px; padding: 20px;">
            <h2>ğŸ“¬ Bildirim Merkezi <span id="admin-badge" style="display:none; color:gold; font-size:0.8rem; border:1px solid gold; padding:2px 5px; border-radius:4px; margin-left:10px;">ğŸ‘‘ Admin</span></h2>
            <div class="tabs">
                <button id="tab-inbox" class="active" onclick="switchTab('inbox')">Gelen Kutusu</button>
                <button id="tab-friends" onclick="switchTab('friends')">ArkadaÅŸlarÄ±m</button>
                <button id="tab-support" onclick="switchTab('support')">Destek</button>
            </div>
            
            <div id="content-inbox" class="tab-content active">
                <div id="inbox-list" style="max-height: 300px; overflow-y: auto;">YÃ¼kleniyor...</div>
            </div>

            <div id="content-friends" class="tab-content">
                <p style="font-size:0.8rem; color:#aaa; margin-bottom:10px;">Buradan arkadaÅŸlarÄ±nÄ±za direkt "Odaya Gel" davetiyesi yollayabilirsiniz.</p>
                <div id="friends-list" style="max-height: 300px; overflow-y: auto;">YÃ¼kleniyor...</div>
            </div>
            
            <div id="content-support" class="tab-content">
                <div id="support-user-view">
                    <p style="font-size:0.8rem; color:#aaa; margin-bottom:10px;">Bir sorununuz mu var veya yeni bir Ã¶zellik mi istiyorsunuz? Bize yazÄ±n.</p>
                    <textarea id="support-msg-input" placeholder="MesajÄ±nÄ±zÄ± buraya yazÄ±n..." style="width:100%; height:80px; padding:10px; background:rgba(0,0,0,0.5); color:#fff; border:1px solid var(--border-color); border-radius:6px; margin-bottom:10px; outline:none; resize:none;"></textarea>
                    <button onclick="sendSupportTicket()" style="background:#2196F3; color:#fff; padding:8px 15px; font-weight:bold; border:none; border-radius:6px; cursor:pointer; width:100%;">Talebi GÃ¶nder</button>
                    <hr style="border-top:1px solid var(--border-color); margin:15px 0;">
                    <h4 style="margin:0 0 10px 0; font-size:0.9rem; color:#aaa;">GeÃ§miÅŸ Taleplerim</h4>
                    <div id="my-tickets-list" style="max-height: 150px; overflow-y: auto;"></div>
                </div>
                <div id="support-admin-view" style="display:none;">
                    <p style="font-size:0.8rem; color:#aaa; margin-bottom:10px;">Gelen kullanÄ±cÄ± taleplerini buradan yanÄ±tlayabilirsiniz.</p>
                    <div id="admin-tickets-list" style="max-height: 300px; overflow-y: auto;"></div>
                </div>
            </div>
            <button class="modal-close" onclick="document.getElementById('inbox-modal').classList.remove('active')">Kapat</button>
        </div>
    </div>

    <div id="wrapped-overlay">
        <div class="w-slide">
            <div class="w-title">Gecenin Ã–zeti ğŸ¿</div>
            <p style="font-size: 1.2rem;">Zaman Ã§ok hÄ±zlÄ± akÄ±yor...</p>
        </div>
        <div class="w-slide">Beraber tam <span class="w-highlight" id="w-stat-time">0</span> dakika izlediniz!</div>
        <div class="w-slide">Sohbete sen <span class="w-highlight" id="w-stat-msg">0</span> mesaj gÃ¶nderdin.</div>
        <div class="w-slide">OdanÄ±n en gevezesi: <span class="w-highlight" id="w-stat-top">Kimse</span></div>
        <div class="w-slide">
            AyrÄ±ca sohbette toplam <span class="w-highlight" id="w-stat-emoji">0</span> emoji fÄ±rlattÄ±nÄ±z! <br>
            <span style="font-size: 1.2rem; color: #ddd;">Harika bir yayÄ±n partisiydi, tekrar gÃ¶rÃ¼ÅŸmek Ã¼zere...</span>
        </div>
    </div>

    <div class="modal-overlay" id="settings-modal">
        <div class="modal">
            <h2>âš™ï¸ Profil & Ayarlar <button id="btn-logout" style="background:#444; color:#fff; border:none; padding:5px 10px; border-radius:4px; cursor:pointer; font-size:0.8rem; display:none;">Ã‡Ä±kÄ±ÅŸ Yap</button></h2>
            <div class="setting-group">
                <label>Profil AvatarÄ± & Resmi</label>
                <div class="avatar-selector" id="avatar-selector-container">
                    <div class="avatar-option selected" data-val="ğŸ‘¤">ğŸ‘¤</div><div class="avatar-option" data-val="ğŸ¦Š">ğŸ¦Š</div>
                    <div class="avatar-option" data-val="ğŸ±">ğŸ±</div><div class="avatar-option" data-val="ğŸ¼">ğŸ¼</div>
                    <div class="avatar-option" data-val="ğŸ¦">ğŸ¦</div><div class="avatar-option" data-val="ğŸ‘½">ğŸ‘½</div>
                </div>
                <div style="margin-top: 10px; text-align: center;">
                    <label class="custom-file-upload">
                        <input type="file" id="custom-avatar-upload" accept="image/*" style="display:none;">
                        ğŸ“· Galeriden Resim SeÃ§
                    </label>
                </div>
            </div>
            
            <div class="setting-group">
                <label>ğŸ™ï¸ Ä°letiÅŸim Modu</label>
                <select id="voice-mode-select">
                    <option value="continuous">SÃ¼rekli AÃ§Ä±k Mikrofon</option>
                    <option value="ptt">Bas-KonuÅŸ (Space TuÅŸu / Mobil Buton)</option>
                </select>
                <label style="display:flex; align-items:center; gap:8px; cursor:pointer; margin-top:10px; color:#fff; text-transform:none;">
                    <input type="checkbox" id="whisper-mode-toggle" style="width:auto; transform: scale(1.2);">
                    FÄ±sÄ±ltÄ± Modu (Sesimi kÄ±sÄ±k ilet)
                </label>
            </div>

            <!-- SES DEÄÄ°ÅTÄ°RÄ°CÄ° SADECE PC Ä°Ã‡Ä°N -->
            <div class="setting-group hide-on-mobile">
                <label>ğŸ™ï¸ Ses DeÄŸiÅŸtirici Efekt</label>
                <select id="voice-effect-select">
                    <option value="none">Normal Ses</option>
                    <option value="robot">ğŸ¤– Robot Sesi</option>
                    <option value="echo">â›°ï¸ MaÄŸara (YankÄ±)</option>
                    <option value="radio">ğŸ“» Eski Radyo</option>
                </select>
                <p style="font-size: 0.75rem; color: #aaa; margin-top: 5px;">* DeÄŸiÅŸikliÄŸin aktif olmasÄ± iÃ§in mikrofonu kapatÄ±p tekrar aÃ§Ä±n.</p>
            </div>

            <div class="setting-group">
                <label>ğŸ”Š Ses KarÄ±ÅŸtÄ±rÄ±cÄ±</label>
                <span style="font-size:0.8rem; color:#888;">Ana Film Sesi</span>
                <input type="range" id="mix-video-vol" min="0" max="100" value="100">
                <span style="font-size:0.8rem; color:#888; display:block; margin-top:5px;">Genel Sohbet Sesi (Bireysel ayarlar hariÃ§)</span>
                <input type="range" id="mix-chat-vol" min="0" max="100" value="100">
            </div>

            <div class="setting-group">
                <label>ğŸ¤ Cihaz SeÃ§imi</label>
                <button id="btn-refresh-devices" class="ctrl-btn settings" style="margin-bottom:8px; width:100%; justify-content:center;">CihazlarÄ± Yenile</button>
                <select id="mic-select"><option value="default">VarsayÄ±lan Mikrofon</option></select>
                <select id="speaker-select" style="margin-top:8px;"><option value="default">VarsayÄ±lan HoparlÃ¶r</option></select>
            </div>
            <button class="modal-close" id="btn-close-settings">Kaydet ve Kapat</button>
        </div>
    </div>

    <div id="login-screen" class="screen active">
        <div class="card" id="auth-card">
            <h1>ğŸ¿ Comba Watch Party</h1>
            <p>Devam etmek iÃ§in giriÅŸ yapÄ±n</p>
            <input type="email" id="email-input" placeholder="E-posta Adresin">
            <input type="password" id="password-input" placeholder="Åifren">
            <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 15px;">
                <button id="btn-email-login" style="background: var(--primary); padding: 12px; border:none; color:#000; border-radius:6px; cursor:pointer; font-weight:bold;">GiriÅŸ Yap / KayÄ±t Ol</button>
                <button id="btn-google-login" style="background: #fff; color: #333; padding: 12px; border:none; border-radius:6px; cursor:pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <svg style="width:20px;height:20px;" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg> 
                    Google ile GiriÅŸ Yap
                </button>
            </div>
        </div>

        <div class="card" id="room-controls" style="display: none;">
            <h1>ğŸ¿ Comba Watch Party</h1>
            <p>HoÅŸ geldin, <span id="display-username" style="color:var(--primary); font-weight:bold;"></span>!</p>
            
            <button id="btn-open-inbox" class="extra-btn" style="background: #0288d1; margin-bottom: 15px; border:none;">ğŸ“¬ Bildirimler & ArkadaÅŸlar</button>

            <input type="text" id="username-input" placeholder="GÃ¶rÃ¼nen AdÄ±n (Ã–rn: PamcÄ±k)">
            <input type="text" id="room-input" placeholder="Oda Kodu (Ã–rn: 1234)">
            
            <button id="btn-open-login-settings" class="extra-btn" style="border:none;">âš™ï¸ Profilini Ayarla</button>
            
            <!-- GÃœNCELLENEN HOST BUTONLARI -->
            <div class="btn-group" style="flex-direction: column;">
                <div style="display: flex; gap: 10px;">
                    <button id="btn-host-screen" style="flex:1; border:none; border-radius:8px; padding:14px; font-weight:bold; cursor:pointer;">ğŸ’» Ekran PaylaÅŸ</button>
                    <button id="btn-host-sync-menu" style="flex:1; border:none; border-radius:8px; padding:14px; font-weight:bold; cursor:pointer;">ğŸ¥ Medya Kur</button>
                </div>
                <button id="btn-viewer" style="width:100%; border:none; border-radius:8px; padding:14px; font-weight:bold; cursor:pointer; margin-top:10px;">ğŸ‘€ Ä°zleyici Ol</button>
            </div>
            <div id="mobile-host-warning">âš ï¸ Mobilden sadece Senkronize Medya (YouTube/MP4) yayÄ±nÄ± kurabilirsiniz. Ekran paylaÅŸÄ±mÄ± PC'ye Ã¶zeldir.</div>
        </div>
    </div>

    <div id="video-screen" class="screen">
        <button id="btn-cinema-exit">âŒ Sinemadan Ã‡Ä±k</button>
        <div class="main-container" id="main-ui-container">
            <div class="video-section">
                <div class="header">
                    <div class="header-left">
                        <h2>ğŸ¿ Oda: <span id="room-display">...</span></h2>
                        <span id="role-display" style="font-size: 0.8rem; color: #aaa;">...</span>
                    </div>
                    <div class="header-controls" id="main-header-controls">
                        <button id="btn-speaker" class="ctrl-btn speaker" title="Sohbet Sesleri">ğŸ”Š<span class="hide-on-mobile"> Sohbet</span></button>
                        <button id="btn-mic" class="ctrl-btn mic" title="Mikrofon">ğŸ¤<span class="hide-on-mobile"> Mikrofon</span></button>
                        
                        <button id="btn-mobile-menu" class="ctrl-btn settings hide-on-desktop" style="padding: 8px 12px;">â˜°</button>
                        
                        <div id="collapsible-controls" class="desktop-controls">
                            <button id="btn-sync-media" class="ctrl-btn hide-on-mobile" style="background:#E53935;" title="Senkronize Medya AÃ§">ğŸ¥ Medya</button>
                            <button id="btn-lobby-music" class="ctrl-btn music" title="Bekleme Salonu MÃ¼ziÄŸi">ğŸµ MÃ¼zik</button>
                            <button id="btn-camera" class="ctrl-btn camera" title="YÃ¼zen KameranÄ± AÃ§">ğŸ“· Kamera</button>
                            <button id="btn-theater" class="ctrl-btn theater" title="Sohbeti Daralt">â†”ï¸ Tiyatro</button>
                            <button id="btn-pip" class="ctrl-btn pip" title="KÃ¼Ã§Ã¼k Pencere">ğŸ“º PiP</button>
                            <button id="btn-cinema" class="ctrl-btn cinema" title="IÅŸÄ±klarÄ± Kapat">ğŸ¬ Sinema</button>
                            <button id="btn-inbox-ingame" class="ctrl-btn settings" title="Mesajlar" style="background:#0288d1;">ğŸ“¬ MenÃ¼</button>
                            <button id="leave-btn" class="ctrl-btn leave">Ã‡Ä±kÄ±ÅŸ</button>
                        </div>
                        
                        <button id="btn-settings" class="ctrl-btn settings" title="Ayarlar">âš™ï¸</button>
                    </div>
                </div>
                
                <div class="video-wrapper">
                    <div id="voice-avatars-container"></div>
                    
                    <canvas id="matter-canvas"></canvas>

                    <video id="main-video" controls autoplay playsinline></video>
                    
                    <div id="sync-media-container">
                        <video id="sync-video" playsinline controls></video>
                        <div id="yt-player"></div>
                    </div>
                    
                    <div id="play-overlay">
                        <h2>ğŸ¿ YayÄ±n Aktif</h2>
                        <p>Sesi aÃ§mak iÃ§in tÄ±klayÄ±n.</p>
                        <button id="force-play-btn">â–¶ BaÅŸlat</button>
                    </div>

                    <div id="admin-announcement-ui">ğŸ“¢ DUYURU BURAYA GELECEK</div>

                    <div id="floating-emoji-container"></div>
                    <div class="reaction-bar" id="reaction-bar">
                        <button class="reaction-btn" data-emoji="ğŸ˜‚">ğŸ˜‚</button>
                        <button class="reaction-btn" data-emoji="ğŸ˜">ğŸ˜</button>
                        <button class="reaction-btn" data-emoji="ğŸ˜®">ğŸ˜®</button>
                        <button class="reaction-btn" data-emoji="ğŸ˜­">ğŸ˜­</button>
                        <button class="reaction-btn" data-emoji="ğŸ”¥">ğŸ”¥</button>
                        <button class="reaction-btn" data-emoji="ğŸ¿">ğŸ¿</button>
                    </div>
                </div>
            </div>

            <div class="layout-resizer" id="main-resizer"></div>

            <div class="sidebar">
                <div class="sidebar-header" id="sidebar-header" title="Koparmak iÃ§in sÃ¼rÃ¼kle, sabitlemek iÃ§in Ã§ift tÄ±kla!">
                    <div style="display:flex; align-items:center; gap: 8px;">
                        <h3>ğŸ’¬ Lobi Sohbeti</h3>
                        <span id="status-text" style="color:#4CAF50; font-size: 0.8rem; font-weight:bold;">BaÄŸlanÄ±lÄ±yor...</span>
                    </div>
                    <div>
                        <button id="btn-toggle-float-mobile" class="ctrl-btn settings hide-on-desktop" style="padding: 4px 8px; font-size: 0.8rem; border: none;">ğŸªŸ Kopar</button>
                        <button id="btn-close-floating-mobile" class="ctrl-btn settings hide-on-desktop" style="padding: 4px 8px; font-size: 0.8rem; background: var(--primary); color: white; border: none;">âŒ</button>
                    </div>
                </div>
                <div class="chat-messages" id="chat-messages"></div>
                <div id="admin-panel">
                    <h4>ğŸ‘‘ Admin MenÃ¼sÃ¼ <button id="btn-clear-chat">Temizle</button></h4>
                    <div style="margin-bottom: 15px; background: rgba(0,0,0,0.3); padding: 8px; border-radius: 6px;">
                        <label style="display:block; font-size:0.75rem; color:#aaa; margin-bottom:5px;">ğŸ¨ Oda TemasÄ± (Herkese UygulanÄ±r)</label>
                        <select id="theme-select" style="width:100%; padding:6px; background:#111; color:white; border:1px solid #444; border-radius:4px;">
                            <option value="default">ğŸ”´ Klasik Comba</option>
                            <option value="theme-cinema">ğŸ¬ AltÄ±n Sinema</option>
                            <option value="theme-cyberpunk">ğŸ‘¾ Siberpunk (Neon)</option>
                            <option value="theme-derbi">âš½ Stadyum (Derbi)</option>
                        </select>
                    </div>
                    <ul id="admin-user-list"></ul>
                </div>
                <div class="chat-input-area">
                    <input type="text" id="chat-input" placeholder="Mesaj veya komut (/zar)...">
                    <button id="chat-send-btn">GÃ¶nder</button>
                </div>
            </div>
        </div>
    </div>

    <!-- FIREBASE VE ANA SCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
        import { getDatabase, ref, set, get, remove, serverTimestamp, push, onValue, onChildAdded, onChildRemoved } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAUh4qKPlNo7K9j6VtKVUHrp8PwaBpa7WE",
            authDomain: "survivor-d69a5.firebaseapp.com",
            databaseURL: "https://survivor-d69a5-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "survivor-d69a5",
            storageBucket: "survivor-d69a5.firebasestorage.app",
            messagingSenderId: "998975421906",
            appId: "1:998975421906:web:972c493b782cce9576dc0b",
            measurementId: "G-VRR63HL878"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        // --- GLOBAL MOBÄ°L KONTROLÃœ ---
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

        // --- SES MOTORUNU SESSÄ°ZCE UYANDIRMA (Sistem Bip Sesi Ã–nleyici) ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        const unlockAudio = () => {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const buffer = audioCtx.createBuffer(1, 1, 22050);
            const source = audioCtx.createBufferSource();
            source.buffer = buffer;
            source.connect(audioCtx.destination);
            if(source.start) source.start(0);
            document.body.removeEventListener('click', unlockAudio);
            document.body.removeEventListener('touchstart', unlockAudio);
        };
        document.body.addEventListener('click', unlockAudio); document.body.addEventListener('touchstart', unlockAudio);

        let stats = { startTime: 0, myMsgCount: 0, totalMsgCount: 0, emojiCount: 0, userMsgCounts: {} };

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const icon = type === 'success' ? 'âœ…' : (type === 'error' ? 'âš ï¸' : 'â„¹ï¸');
            toast.innerHTML = `<span>${icon}</span> <span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 3000);
        }

        // DeÄŸiÅŸkenler
        let peer = null, myStream = null, micStream = null, faceCamStream = null;
        let isHost = false, myUsername = "Anonim", myAvatar = "ğŸ‘¤", roomCode = "", hostId = "";
        let hostConnection = null, viewers = new Map(), activeVoiceCalls = new Map(), myFaceCamCalls = [], activeAudioElements = []; 
        let currentTheme = 'default';
        let isAdmin = false, myUid = "anon_" + Date.now();
        let globalMicEnabled = false; 

        // Bireysel Ses ve Profil HaritalarÄ±
        let peerVolumes = {}; 
        let peerProfiles = {}; 

        // Senkronize Medya OynatÄ±cÄ± 
        let ytPlayer = null;
        let syncActive = false;
        let isSyncHostControl = false;

        const videoElement = document.getElementById('main-video');
        const syncMediaContainer = document.getElementById('sync-media-container');
        const syncVideo = document.getElementById('sync-video');
        const playOverlay = document.getElementById('play-overlay');
        const statusText = document.getElementById('status-text');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        
        const btnMic = document.getElementById('btn-mic');
        const btnSpeaker = document.getElementById('btn-speaker');
        const btnCamera = document.getElementById('btn-camera');
        const pttBtnMobile = document.getElementById('ptt-btn-mobile');
        const mainUiContainer = document.getElementById('main-ui-container');

        const activeSpeakers = new Map();

        // --- SES DEÄÄ°ÅTÄ°RÄ°CÄ° (VOICE CHANGER) MANTIÄI ---
        let currentVoiceEffect = 'none';
        let audioCtxProcessing = null;

        document.getElementById('voice-effect-select').addEventListener('change', (e) => {
            currentVoiceEffect = e.target.value;
        });

        function makeDistortionCurve(amount) {
          const k = amount; const n_samples = 44100; const curve = new Float32Array(n_samples); const deg = Math.PI / 180;
          for (let i = 0; i < n_samples; ++i) {
            const x = i * 2 / n_samples - 1;
            curve[i] = (3 + k) * x * 20 * deg / (Math.PI + k * Math.abs(x));
          }
          return curve;
        }

        function applyVoiceEffect(rawStream) {
            // Mobilde Ã§alÄ±ÅŸmasÄ±n ve Efekt seÃ§ilmediyse doÄŸrudan ham sesi dÃ¶ndÃ¼rsÃ¼n
            if (isMobile || currentVoiceEffect === 'none') return rawStream;

            if (!audioCtxProcessing) {
                audioCtxProcessing = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtxProcessing.state === 'suspended') audioCtxProcessing.resume();

            const source = audioCtxProcessing.createMediaStreamSource(rawStream);
            const dest = audioCtxProcessing.createMediaStreamDestination();

            if (currentVoiceEffect === 'robot') {
                const distortion = audioCtxProcessing.createWaveShaper();
                distortion.curve = makeDistortionCurve(50);
                const biquad = audioCtxProcessing.createBiquadFilter();
                biquad.type = "bandpass";
                biquad.frequency.value = 1000;
                source.connect(distortion);
                distortion.connect(biquad);
                biquad.connect(dest);
            } else if (currentVoiceEffect === 'echo') {
                const delay = audioCtxProcessing.createDelay();
                delay.delayTime.value = 0.4;
                const feedback = audioCtxProcessing.createGain();
                feedback.gain.value = 0.5;
                source.connect(delay);
                delay.connect(feedback);
                feedback.connect(delay);
                source.connect(dest);
                delay.connect(dest);
            } else if (currentVoiceEffect === 'radio') {
                const hp = audioCtxProcessing.createBiquadFilter();
                hp.type = 'highpass'; hp.frequency.value = 1200;
                const lp = audioCtxProcessing.createBiquadFilter();
                lp.type = 'lowpass'; lp.frequency.value = 3200;
                const distortion = audioCtxProcessing.createWaveShaper();
                distortion.curve = makeDistortionCurve(20);
                source.connect(hp); hp.connect(lp); lp.connect(distortion); distortion.connect(dest);
            }

            return dest.stream;
        }

        // Ã–zel Avatar Formatlama
        function renderAvatarHtml(avatarData) {
            if(avatarData && avatarData.startsWith('data:image')) {
                return `<img src="${avatarData}">`;
            }
            return avatarData || "ğŸ‘¤";
        }

        // --- BÄ°REYSEL KULLANICI MODALI ---
        let selectedActionPeerId = null;
        function openUserActionModal(pId, pName, pAvatar, pUid) {
            selectedActionPeerId = pId;
            document.getElementById('ua-avatar').innerHTML = renderAvatarHtml(pAvatar);
            document.getElementById('ua-name').innerText = pName;
            document.getElementById('ua-role').innerText = pId === hostId ? "YayÄ±ncÄ±" : "Ä°zleyici";
            
            const slider = document.getElementById('ua-vol-slider');
            slider.value = peerVolumes[pId] !== undefined ? peerVolumes[pId] * 100 : 100;
            
            const btnFriend = document.getElementById('ua-btn-add-friend');
            if (pId === 'local' || pUid === myUid || !auth.currentUser) {
                btnFriend.style.display = 'none';
            } else {
                btnFriend.style.display = 'block';
                btnFriend.onclick = () => { addFriend(pUid, pName); };
            }
            
            document.getElementById('user-action-modal').classList.add('active');
        }

        document.getElementById('ua-vol-slider').addEventListener('input', (e) => {
            if(!selectedActionPeerId) return;
            const vol = e.target.value / 100;
            peerVolumes[selectedActionPeerId] = vol;
            // O kiÅŸinin audiosunu bul ve gÃ¼ncelle
            const targetAudio = activeAudioElements.find(a => a.dataset.peerId === selectedActionPeerId);
            if(targetAudio) targetAudio.volume = vol;
        });

        document.getElementById('ua-btn-mute').addEventListener('click', () => {
            if(!selectedActionPeerId) return;
            document.getElementById('ua-vol-slider').value = 0;
            peerVolumes[selectedActionPeerId] = 0;
            const targetAudio = activeAudioElements.find(a => a.dataset.peerId === selectedActionPeerId);
            if(targetAudio) targetAudio.volume = 0;
        });

        // --- SENKRONÄ°ZE MEDYA OYNATICI (YouTube & MP4) ---
        function onYouTubeIframeAPIReady() {
            ytPlayer = new YT.Player('yt-player', {
                height: '100%', width: '100%',
                playerVars: { 'playsinline': 1, 'controls': isHost ? 1 : 0, 'rel': 0 },
                events: {
                    'onReady': (event) => { if(syncActive && !isHost) event.target.playVideo(); },
                    'onStateChange': onYtStateChange
                }
            });
        }
        
        function onYtStateChange(event) {
            if (!isHost || !syncActive) return;
            const time = ytPlayer.getCurrentTime();
            if (event.data == YT.PlayerState.PLAYING) broadcastData({ type: 'SYNC_MEDIA', action: 'play', time: time });
            else if (event.data == YT.PlayerState.PAUSED) broadcastData({ type: 'SYNC_MEDIA', action: 'pause', time: time });
        }
        
        // Host pozisyon gÃ¶nderici dÃ¶ngÃ¼
        setInterval(() => {
            if(isHost && syncActive) {
                let time = 0;
                if(ytPlayer && ytPlayer.getPlayerState && ytPlayer.getPlayerState() === YT.PlayerState.PLAYING) time = ytPlayer.getCurrentTime();
                else if(!syncVideo.paused) time = syncVideo.currentTime;
                
                if(time > 0) broadcastData({ type: 'SYNC_MEDIA', action: 'time_update', time: time });
            }
        }, 3000);

        document.getElementById('btn-start-sync').addEventListener('click', () => {
            const url = document.getElementById('sync-url-input').value.trim();
            if(!url) return showToast("LÃ¼tfen bir URL girin.", "error");
            
            document.getElementById('sync-media-modal').classList.remove('active');
            document.getElementById('btn-stop-sync').style.display = 'block';
            
            // Ekran paylaÅŸÄ±mÄ±nÄ± durdur (EÄŸer aÃ§Ä±ksa)
            if(myStream) { myStream.getVideoTracks().forEach(t => t.stop()); }
            
            broadcastData({ type: 'SYNC_MEDIA_START', url: url });
            handleSyncMediaStart(url, true);
        });

        document.getElementById('btn-stop-sync').addEventListener('click', () => {
            document.getElementById('sync-media-modal').classList.remove('active');
            document.getElementById('btn-stop-sync').style.display = 'none';
            document.getElementById('sync-url-input').value = '';
            broadcastData({ type: 'SYNC_MEDIA_STOP' });
            handleSyncMediaStop();
        });

        function handleSyncMediaStart(url, amIHost) {
            syncActive = true;
            isSyncHostControl = amIHost;
            videoElement.style.display = 'none';
            syncMediaContainer.style.display = 'block';
            document.getElementById('yt-player').style.display = 'none';
            syncVideo.style.display = 'none';

            // Check if YouTube
            const ytMatch = url.match(/(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))((\w|-){11})/);
            
            if (ytMatch && ytMatch[1]) {
                const vidId = ytMatch[1];
                document.getElementById('yt-player').style.display = 'block';
                if(ytPlayer && ytPlayer.loadVideoById) {
                    ytPlayer.loadVideoById(vidId);
                } else {
                    // API henÃ¼z yÃ¼klenmediyse bekle
                    setTimeout(() => handleSyncMediaStart(url, amIHost), 1000); 
                }
            } else {
                // Standart Video (MP4, m3u8 vb)
                syncVideo.style.display = 'block';
                syncVideo.src = url;
                syncVideo.controls = amIHost; // Ä°zleyiciler tÄ±klayamaz
                syncVideo.play().catch(e=> playOverlay.style.display='flex');
                
                if (amIHost) {
                    syncVideo.onplay = () => broadcastData({ type: 'SYNC_MEDIA', action: 'play', time: syncVideo.currentTime });
                    syncVideo.onpause = () => broadcastData({ type: 'SYNC_MEDIA', action: 'pause', time: syncVideo.currentTime });
                    syncVideo.onseeked = () => broadcastData({ type: 'SYNC_MEDIA', action: 'seek', time: syncVideo.currentTime });
                }
            }
            showToast(amIHost ? "Senkronize medya baÅŸlatÄ±ldÄ±!" : "YayÄ±ncÄ± yeni bir medya baÅŸlattÄ±.", "success");
        }

        function handleSyncMediaStop() {
            syncActive = false;
            syncMediaContainer.style.display = 'none';
            videoElement.style.display = 'block';
            if(ytPlayer && ytPlayer.stopVideo) ytPlayer.stopVideo();
            syncVideo.pause(); syncVideo.src = "";
            showToast("Senkronize medya kapatÄ±ldÄ±.", "info");
        }

        function handleIncomingSyncCommand(data) {
            if(data.type === 'SYNC_MEDIA_START') { handleSyncMediaStart(data.url, false); }
            else if (data.type === 'SYNC_MEDIA_STOP') { handleSyncMediaStop(); }
            else if (data.type === 'SYNC_MEDIA' && syncActive && !isHost) {
                const isYt = document.getElementById('yt-player').style.display === 'block';
                const time = data.time;
                
                if (isYt && ytPlayer) {
                    if (data.action === 'play') { ytPlayer.seekTo(time); ytPlayer.playVideo(); }
                    else if (data.action === 'pause') { ytPlayer.pauseVideo(); ytPlayer.seekTo(time); }
                    else if (data.action === 'time_update' || data.action === 'seek') {
                        if (Math.abs(ytPlayer.getCurrentTime() - time) > 2) ytPlayer.seekTo(time);
                    }
                } else {
                    if (data.action === 'play') { syncVideo.currentTime = time; syncVideo.play(); }
                    else if (data.action === 'pause') { syncVideo.pause(); syncVideo.currentTime = time; }
                    else if (data.action === 'time_update' || data.action === 'seek') {
                        if (Math.abs(syncVideo.currentTime - time) > 2) syncVideo.currentTime = time;
                    }
                }
            }
        }


        // --- DÄ°ÄER FONKSÄ°YONLAR ---
        // Ã–zel Avatar YÃ¼kleme
        document.getElementById('custom-avatar-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(evt) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    canvas.width = 128; canvas.height = 128; // Boyutu kÃ¼Ã§Ã¼k tut
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, 128, 128);
                    
                    const base64Data = canvas.toDataURL('image/jpeg', 0.7);
                    myAvatar = base64Data;
                    
                    document.querySelectorAll('.avatar-option').forEach(a => a.classList.remove('selected'));
                    const customOpt = document.createElement('div');
                    customOpt.className = 'avatar-option selected';
                    customOpt.innerHTML = `<img src="${base64Data}">`;
                    document.getElementById('avatar-selector-container').appendChild(customOpt);
                    
                    // Firebase Profile Kaydet
                    if(auth.currentUser) set(ref(database, 'users/' + auth.currentUser.uid + '/avatar'), myAvatar);
                    
                    showToast("Ã–zel avatarÄ±nÄ±z yÃ¼klendi ve kaydedildi!", "success");
                };
                img.src = evt.target.result;
            };
            reader.readAsDataURL(file);
        });

        // ğŸ“± Mobil MenÃ¼
        document.getElementById('btn-mobile-menu').addEventListener('click', () => {
            document.getElementById('collapsible-controls').classList.toggle('open');
        });

        // ğŸ› ï¸ Sezgisel DÃ¼zen
        const resizer = document.getElementById('main-resizer');
        const sidebar = document.querySelector('.sidebar');
        const sidebarHeader = document.getElementById('sidebar-header');
        let isResizing = false;

        resizer.addEventListener('mousedown', (e) => { isResizing = true; resizer.classList.add('dragging'); document.body.style.cursor = 'col-resize'; e.preventDefault(); });
        resizer.addEventListener('touchstart', (e) => { isResizing = true; resizer.classList.add('dragging'); });
        
        window.addEventListener('mousemove', (e) => {
            if (!isResizing || sidebar.classList.contains('floating')) return;
            let newWidth = window.innerWidth - e.clientX;
            if (newWidth < 250) newWidth = 250;
            if (newWidth > window.innerWidth * 0.6) newWidth = window.innerWidth * 0.6;
            document.documentElement.style.setProperty('--chat-width', newWidth + 'px');
        });
        window.addEventListener('mouseup', () => { if(isResizing) { isResizing = false; resizer.classList.remove('dragging'); document.body.style.cursor = 'default'; } });
        window.addEventListener('touchend', () => { if(isResizing) { isResizing = false; resizer.classList.remove('dragging'); } });

        let isDraggingFloat = false, startX, startY, initialTop, initialLeft;
        sidebarHeader.addEventListener('mousedown', floatDragStart);
        sidebarHeader.addEventListener('touchstart', floatDragStart, {passive: false});
        sidebarHeader.addEventListener('dblclick', () => { 
            sidebar.classList.remove('floating'); document.body.classList.remove('chat-floating', 'chat-floating-minimized');
            showToast("Pencere sabitlendi", "info");
        });

        function floatDragStart(e) {
            if (e.target.tagName.toLowerCase() === 'button' || window.innerWidth <= 768) return; 
            isDraggingFloat = true;
            let clientX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
            let clientY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;

            if (!sidebar.classList.contains('floating')) {
                sidebar.classList.add('floating');
                document.documentElement.style.setProperty('--float-left', (clientX - 100) + 'px');
                document.documentElement.style.setProperty('--float-top', (clientY - 20) + 'px');
            }

            const rect = sidebar.getBoundingClientRect();
            initialTop = rect.top; initialLeft = rect.left;
            startX = clientX; startY = clientY;
            document.addEventListener('mousemove', floatDrag); document.addEventListener('touchmove', floatDrag, {passive: false});
            document.addEventListener('mouseup', floatDragEnd); document.addEventListener('touchend', floatDragEnd);
        }
        function floatDrag(e) {
            if (!isDraggingFloat) return; e.preventDefault();
            let currentX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
            let currentY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;
            const dx = currentX - startX; const dy = currentY - startY;
            document.documentElement.style.setProperty('--float-top', (initialTop + dy) + 'px');
            document.documentElement.style.setProperty('--float-left', (initialLeft + dx) + 'px');
        }
        function floatDragEnd() {
            isDraggingFloat = false;
            document.removeEventListener('mousemove', floatDrag); document.removeEventListener('touchmove', floatDrag);
            document.removeEventListener('mouseup', floatDragEnd); document.removeEventListener('touchend', floatDragEnd);
        }

        const btnToggleFloatMobile = document.getElementById('btn-toggle-float-mobile');
        const btnCloseFloatingMobile = document.getElementById('btn-close-floating-mobile');
        const mobileBubbleBtn = document.getElementById('mobile-chat-bubble-btn');

        btnToggleFloatMobile.addEventListener('click', (e) => { e.stopPropagation(); sidebar.classList.add('floating'); document.body.classList.add('chat-floating'); showToast("Sohbet koptu.", "info"); });
        btnCloseFloatingMobile.addEventListener('click', (e) => { e.stopPropagation(); document.body.classList.add('chat-floating-minimized'); });
        mobileBubbleBtn.addEventListener('click', () => { document.body.classList.remove('chat-floating-minimized'); });


        // --- ğŸ… MATTER.JS FÄ°ZÄ°KSEL EKRAN ---
        const Engine = Matter.Engine, Render = Matter.Render, Runner = Matter.Runner, Bodies = Matter.Bodies, Composite = Matter.Composite, Events = Matter.Events;
        const physicsEngine = Engine.create();
        const matterCanvas = document.getElementById('matter-canvas');
        const physicsRender = Render.create({ canvas: matterCanvas, engine: physicsEngine, options: { width: window.innerWidth, height: window.innerHeight, background: 'transparent', wireframes: false } });
        
        let physicsWalls = [];
        function updateMatterBounds() {
            const w = document.querySelector('.video-wrapper').clientWidth;
            const h = document.querySelector('.video-wrapper').clientHeight;
            matterCanvas.width = w; matterCanvas.height = h;
            physicsRender.options.width = w; physicsRender.options.height = h;
            
            if(physicsWalls.length > 0) Composite.remove(physicsEngine.world, physicsWalls);
            const ground = Bodies.rectangle(w/2, h + 25, w, 50, { isStatic: true });
            const wallL = Bodies.rectangle(-25, h/2, 50, h, { isStatic: true });
            const wallR = Bodies.rectangle(w+25, h/2, 50, h, { isStatic: true });
            physicsWalls = [ground, wallL, wallR];
            Composite.add(physicsEngine.world, physicsWalls);
        }
        window.addEventListener('resize', updateMatterBounds);

        Events.on(physicsRender, 'afterRender', function() {
            const ctx = physicsRender.context; ctx.font = "35px Arial"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
            Composite.allBodies(physicsEngine.world).forEach(body => {
                if (body.plugin && body.plugin.emoji) {
                    ctx.save(); ctx.translate(body.position.x, body.position.y); ctx.rotate(body.angle); ctx.fillText(body.plugin.emoji, 0, 0); ctx.restore();
                }
            });
        });

        Runner.run(Runner.create(), physicsEngine); Render.run(physicsRender);

        let dragEmojiEl = null, dragEmojiChar = '', dragHistory = [];
        document.querySelectorAll('.reaction-btn').forEach(btn => { btn.addEventListener('mousedown', startEmojiDrag); btn.addEventListener('touchstart', startEmojiDrag, {passive: false}); });

        function startEmojiDrag(e) {
            e.preventDefault(); dragEmojiChar = e.target.dataset.emoji; dragEmojiEl = document.createElement('div'); dragEmojiEl.className = 'dragged-emoji'; dragEmojiEl.innerText = dragEmojiChar; document.body.appendChild(dragEmojiEl);
            let clientX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX; let clientY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;
            dragEmojiEl.style.left = clientX + 'px'; dragEmojiEl.style.top = clientY + 'px'; dragHistory = [{x: clientX, y: clientY, t: Date.now()}];
            document.addEventListener('mousemove', moveEmojiDrag); document.addEventListener('touchmove', moveEmojiDrag, {passive: false}); document.addEventListener('mouseup', endEmojiDrag); document.addEventListener('touchend', endEmojiDrag);
        }
        function moveEmojiDrag(e) {
            if(!dragEmojiEl) return; e.preventDefault();
            let clientX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX; let clientY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;
            dragEmojiEl.style.left = clientX + 'px'; dragEmojiEl.style.top = clientY + 'px'; dragHistory.push({x: clientX, y: clientY, t: Date.now()});
            if(dragHistory.length > 5) dragHistory.shift();
        }
        function endEmojiDrag(e) {
            if(!dragEmojiEl) return;
            document.removeEventListener('mousemove', moveEmojiDrag); document.removeEventListener('touchmove', moveEmojiDrag); document.removeEventListener('mouseup', endEmojiDrag); document.removeEventListener('touchend', endEmojiDrag);
            let vx = 0, vy = -15; 
            if (dragHistory.length > 1) {
                const first = dragHistory[0]; const last = dragHistory[dragHistory.length - 1]; const dt = last.t - first.t;
                if(dt > 0) { vx = ((last.x - first.x) / dt) * 15; vy = ((last.y - first.y) / dt) * 15; }
            }
            const rect = document.querySelector('.video-wrapper').getBoundingClientRect();
            let dropX = dragHistory[dragHistory.length - 1].x - rect.left; let dropY = dragHistory[dragHistory.length - 1].y - rect.top;
            if(dropX < 0 || dropX > rect.width || dropY < 0 || dropY > rect.height) { dropX = rect.width / 2; dropY = rect.height - 50; }
            dragEmojiEl.remove(); dragEmojiEl = null;
            spawnPhysicsEmoji(dragEmojiChar, dropX, dropY, vx, vy, true);
        }

        function spawnPhysicsEmoji(emoji, x, y, vx, vy, isLocalThrow = false) {
            const body = Bodies.circle(x, y, 20, { restitution: 0.8, frictionAir: 0.01, density: 0.04, plugin: { emoji: emoji } });
            Matter.Body.setVelocity(body, { x: vx, y: vy }); Composite.add(physicsEngine.world, body);
            setTimeout(() => { Composite.remove(physicsEngine.world, body); }, 8000); 
            if(isLocalThrow) {
                stats.emojiCount++;
                const data = { type: 'PHYSICS_EMOJI', emoji: emoji, xRatio: x / matterCanvas.width, yRatio: y / matterCanvas.height, vx: vx, vy: vy };
                broadcastData(data);
            }
        }


        // --- KÄ°MLÄ°K DOÄRULAMA (AUTH) ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                myUid = user.uid;
                myUsername = user.displayName || user.email.split('@')[0];
                isAdmin = (user.email === 'yusar646@gmail.com');
                
                // Profil resmini Ã§ek (Ã–zel Avatar varsa)
                get(ref(database, 'users/' + myUid + '/avatar')).then(snap => {
                    if (snap.exists() && snap.val()) {
                        myAvatar = snap.val();
                        const customOpt = document.createElement('div');
                        customOpt.className = 'avatar-option selected';
                        customOpt.innerHTML = `<img src="${myAvatar}">`;
                        document.getElementById('avatar-selector-container').appendChild(customOpt);
                    }
                });

                document.getElementById('auth-card').style.display = 'none';
                document.getElementById('room-controls').style.display = 'block';
                document.getElementById('display-username').innerText = myUsername;
                document.getElementById('username-input').value = myUsername; 
                document.getElementById('btn-logout').style.display = 'inline-block';
                
                document.getElementById('admin-badge').style.display = isAdmin ? 'inline' : 'none';
                document.getElementById('support-user-view').style.display = isAdmin ? 'none' : 'block';
                document.getElementById('support-admin-view').style.display = isAdmin ? 'block' : 'none';

                showToast(`HoÅŸ geldin, ${myUsername}!`, 'success');
            } else {
                document.getElementById('auth-card').style.display = 'block';
                document.getElementById('room-controls').style.display = 'none';
                document.getElementById('btn-logout').style.display = 'none';
                isAdmin = false;
            }
        });

        document.getElementById('btn-google-login').addEventListener('click', () => { signInWithPopup(auth, new GoogleAuthProvider()).catch(err => showToast(err.message, 'error')); });
        document.getElementById('btn-email-login').addEventListener('click', () => {
            const email = document.getElementById('email-input').value; const pass = document.getElementById('password-input').value;
            if(!email || !pass) return showToast('E-posta ve ÅŸifre giriniz', 'error');
            signInWithEmailAndPassword(auth, email, pass).catch(err => {
                if(err.code === 'auth/user-not-found' || err.code === 'auth/invalid-credential') createUserWithEmailAndPassword(auth, email, pass).catch(e => showToast(e.message, 'error'));
                else showToast('GiriÅŸ HatasÄ±: ' + err.message, 'error');
            });
        });
        document.getElementById('btn-logout').addEventListener('click', () => { signOut(auth); document.getElementById('settings-modal').classList.remove('active'); });

        // --- INBOX, DESTEK VE ARKADAÅLAR MANTIÄI ---
        function loadInboxAndSupport() {
            if(!auth.currentUser) return;

            // Gelen Kutusu
            onValue(ref(database, 'inbox/' + myUid), (snapshot) => {
                const list = document.getElementById('inbox-list'); list.innerHTML = '';
                if(snapshot.exists()) {
                    snapshot.forEach(child => { 
                        const d = child.val(); 
                        list.innerHTML += `<div class="ticket-item">
                            <div><b>${d.from}</b> <br> <span style="font-size:0.8rem; color:#ccc;">${d.message}</span></div>
                            ${d.type === 'invite' ? `<button class="friend-btn" onclick="document.getElementById('room-input').value='${d.roomCode}'; document.getElementById('btn-viewer').click(); document.getElementById('inbox-modal').classList.remove('active');">KatÄ±l</button>` : ''}
                        </div>`; 
                    });
                } else { list.innerHTML = '<p style="color:#888;">Gelen kutun boÅŸ.</p>'; }
            });

            // ArkadaÅŸlar Sekmesi
            onValue(ref(database, 'users/' + myUid + '/friends'), (snapshot) => {
                const flist = document.getElementById('friends-list'); flist.innerHTML = '';
                if (snapshot.exists()) {
                    snapshot.forEach(child => {
                        const fId = child.key; const fName = child.val();
                        flist.innerHTML += `<div class="ticket-item">
                            <span>ğŸ¤ ${fName}</span>
                            <button class="friend-btn" onclick="inviteFriend('${fId}', '${fName}')">Odaya Davet Et</button>
                        </div>`;
                    });
                } else { flist.innerHTML = '<p style="color:#888;">HenÃ¼z ekli arkadaÅŸÄ±nÄ±z yok. Sohbette kiÅŸilerin Ã¼zerine tÄ±klayarak ekleyebilirsiniz.</p>'; }
            });

            onValue(ref(database, 'support_tickets'), (snapshot) => {
                const myTicketsList = document.getElementById('my-tickets-list'); myTicketsList.innerHTML = '';
                const adminList = document.getElementById('admin-tickets-list'); adminList.innerHTML = '';
                
                if(snapshot.exists()) {
                    snapshot.forEach(child => {
                        const d = child.val(); const tId = child.key;
                        if(isAdmin) {
                            adminList.innerHTML += `<div class="ticket-item" style="flex-direction:column; align-items:flex-start;">
                                <div><b>Kimden:</b> ${d.email} <br><b>Soru:</b> ${d.message}</div>
                                <div style="display:flex; width:100%; gap:5px;"><input type="text" id="reply-${tId}" placeholder="YanÄ±t yazÄ±n..."><button class="friend-btn" onclick="window.replyTicket('${tId}', '${d.uid}')">GÃ¶nder</button></div>
                            </div>`;
                        } else if (d.uid === myUid) {
                            myTicketsList.innerHTML += `<div class="ticket-item"><b>Sordun:</b> ${d.message} <br><span style="color:#888; font-size:0.75rem;">(YanÄ±t Bekliyor)</span></div>`;
                        }
                    });
                } else {
                    adminList.innerHTML = '<p style="color:#888;">Bekleyen talep yok.</p>';
                    if(myTicketsList.innerHTML === '') myTicketsList.innerHTML = '<p style="color:#888;">HenÃ¼z bir talebiniz yok.</p>';
                }
            });
        }

        window.switchTab = function(tab) {
            document.querySelectorAll('#inbox-modal .tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('#inbox-modal .tabs button').forEach(el => el.classList.remove('active'));
            document.getElementById('content-' + tab).classList.add('active');
            document.getElementById('tab-' + tab).classList.add('active');
        };

        window.sendSupportTicket = function() {
            const msg = document.getElementById('support-msg-input').value.trim();
            if(!msg) return;
            push(ref(database, 'support_tickets'), { uid: auth.currentUser.uid, email: auth.currentUser.email, message: msg, timestamp: serverTimestamp() });
            document.getElementById('support-msg-input').value = '';
            showToast("Destek talebi gÃ¶nderildi.", "success");
        };

        window.replyTicket = function(ticketId, userUid) {
            const replyMsg = document.getElementById('reply-' + ticketId).value.trim();
            if(!replyMsg) return;
            push(ref(database, 'inbox/' + userUid), { from: 'ğŸ‘‘ Admin', message: replyMsg, timestamp: serverTimestamp(), type: 'msg' }).then(() => {
                remove(ref(database, 'support_tickets/' + ticketId)); 
                showToast("YanÄ±t baÅŸarÄ±yla gÃ¶nderildi.", "success");
            });
        };

        window.addFriend = function(targetUid, targetName) {
            if(!auth.currentUser) return showToast("GiriÅŸ yapmalÄ±sÄ±nÄ±z", "error");
            set(ref(database, `users/${myUid}/friends/${targetUid}`), targetName);
            showToast(`${targetName} arkadaÅŸlara eklendi!`, "success");
            document.getElementById('user-action-modal').classList.remove('active');
        };

        window.inviteFriend = function(targetUid, targetName) {
            if(!roomCode) return showToast("Ã–nce bir odaya katÄ±lÄ±n veya kurun.", "error");
            push(ref(database, `inbox/${targetUid}`), { from: myUsername, message: `Seni bir yayÄ±n partisine davet ediyor!`, roomCode: roomCode, type: 'invite', timestamp: serverTimestamp() });
            showToast(`${targetName} davet edildi!`, "success");
        };

        const openInbox = () => { document.getElementById('inbox-modal').classList.add('active'); loadInboxAndSupport(); };
        document.getElementById('btn-open-inbox').addEventListener('click', openInbox);
        document.getElementById('btn-inbox-ingame').addEventListener('click', openInbox);

        // --- LOBÄ° MÃœZÄ°ÄÄ° MANTIÄI ---
        let isLobbyMusicPlaying = false;
        const lobbyAudio = document.getElementById('lobby-audio');
        lobbyAudio.volume = 0;

        function fadeAudio(audio, targetVolume, duration) {
            const steps = 20; const stepTime = duration / steps; const diff = (targetVolume - audio.volume) / steps;
            const interval = setInterval(() => {
                let newVol = audio.volume + diff;
                if(newVol < 0) newVol = 0; if(newVol > 1) newVol = 1;
                audio.volume = newVol;
                if(Math.abs(audio.volume - targetVolume) < 0.05) { audio.volume = targetVolume; clearInterval(interval); if(targetVolume === 0) audio.pause(); }
            }, stepTime);
        }

        window.toggleLobbyMusic = function(forceState) {
            isLobbyMusicPlaying = forceState !== undefined ? forceState : !isLobbyMusicPlaying;
            const btn = document.getElementById('btn-lobby-music');
            if(isLobbyMusicPlaying) { lobbyAudio.play().catch(e => console.warn("MÃ¼zik Ã§alma izni yok", e)); fadeAudio(lobbyAudio, 0.4, 1000); btn.classList.add('active'); } 
            else { fadeAudio(lobbyAudio, 0, 1000); btn.classList.remove('active'); }
        };

        document.getElementById('btn-lobby-music').addEventListener('click', () => {
            if(!isHost) return showToast("Sadece YayÄ±ncÄ± mÃ¼ziÄŸi kontrol edebilir.", "error");
            window.toggleLobbyMusic();
            broadcastData({ type: 'LOBBY_MUSIC', state: isLobbyMusicPlaying });
        });

        function createFaceCamUI(id, uname, stream, muted) {
            if(document.getElementById('facecam-'+id)) return;
            const div = document.createElement('div');
            div.id = 'facecam-' + id; div.className = 'face-cam-bubble';
            div.innerHTML = `<video autoplay playsinline ${muted ? 'muted' : ''}></video><div class="face-cam-name">${uname}</div>`;
            document.querySelector('.video-wrapper').appendChild(div);
            div.querySelector('video').srcObject = stream; makeDraggable(div);
            div.style.top = (40 + Math.random() * 40) + 'px'; div.style.left = (40 + Math.random() * 100) + 'px';
        }

        btnCamera.addEventListener('click', async () => {
            if (faceCamStream) {
                faceCamStream.getTracks().forEach(t => t.stop()); faceCamStream = null;
                btnCamera.classList.remove('active'); btnCamera.innerHTML = "ğŸ“· Kamera";
                document.getElementById('facecam-local')?.remove();
                myFaceCamCalls.forEach(c => c.close()); myFaceCamCalls = [];
                broadcastData({ type: 'FACECAM_OFF', peerId: peer.id });
            } else {
                try {
                    faceCamStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                    btnCamera.classList.add('active'); btnCamera.innerHTML = "ğŸ›‘ KamerayÄ± Kapat";
                    createFaceCamUI('local', myUsername, faceCamStream, true);
                    const meta = { type: 'facecam', username: myUsername, uid: myUid };
                    if (isHost) { viewers.forEach((v, pId) => { const c = peer.call(pId, faceCamStream, { metadata: meta }); myFaceCamCalls.push(c); }); } 
                    else { 
                        myFaceCamCalls.push(peer.call(hostId, faceCamStream, { metadata: meta }));
                        otherPeers.forEach(pId => { myFaceCamCalls.push(peer.call(pId, faceCamStream, { metadata: meta })); });
                    }
                } catch(e) { showToast("Kamera izni reddedildi!", "error"); }
            }
        });

        window.applyTheme = function(theme) {
            document.body.classList.remove('theme-cinema', 'theme-cyberpunk', 'theme-derbi');
            if (theme !== 'default') document.body.classList.add(theme);
        };
        document.getElementById('theme-select').addEventListener('change', (e) => {
            currentTheme = e.target.value; window.applyTheme(currentTheme);
            broadcastData({ type: 'THEME', theme: currentTheme });
        });

        window.triggerEffect = function(type) {
            if (type === 'scare') {
                document.body.classList.add('jumpscare'); if(navigator.vibrate) navigator.vibrate([200, 100, 200, 100, 400]); 
                setTimeout(() => document.body.classList.remove('jumpscare'), 1500);
            } else if (type === 'party') {
                if(navigator.vibrate) navigator.vibrate(300);
                for(let i=0; i<50; i++) {
                    const conf = document.createElement('div'); conf.className = 'confetti';
                    conf.style.left = Math.random() * 100 + 'vw'; conf.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
                    conf.style.animationDuration = (Math.random() * 2 + 2) + 's'; document.body.appendChild(conf); setTimeout(() => conf.remove(), 4000);
                }
            }
        };

        window.showAdminAnnouncement = function(msg) {
            const el = document.getElementById('admin-announcement-ui'); el.innerText = `ğŸ“¢ DUYURU: ${msg}`;
            el.style.display = 'block'; el.style.animation = 'pulse 1s infinite';
            addChatMessage("Sistem", "ğŸ“¢", `DUYURU: ${msg}`, false); setTimeout(() => { el.style.display = 'none'; el.style.animation = ''; }, 6000); 
        };

        // --- AYARLAR MODALI ---
        const settingsModal = document.getElementById('settings-modal');
        let selectedMicId = 'default', selectedSpeakerId = 'default';
        let isPttMode = false, isWhisperMode = false, isTalking = false;

        document.getElementById('btn-settings').addEventListener('click', () => settingsModal.classList.add('active'));
        document.getElementById('btn-open-login-settings').addEventListener('click', () => settingsModal.classList.add('active'));
        document.getElementById('btn-close-settings').addEventListener('click', () => settingsModal.classList.remove('active'));
        document.querySelectorAll('.avatar-option').forEach(el => { 
            el.addEventListener('click', () => { 
                document.querySelectorAll('.avatar-option').forEach(a => a.classList.remove('selected')); 
                el.classList.add('selected'); 
                myAvatar = el.dataset.val; 
            }); 
        });

        document.getElementById('voice-mode-select').addEventListener('change', (e) => {
            isPttMode = (e.target.value === 'ptt');
            if(isPttMode && micStream) { 
                micStream.getAudioTracks().forEach(t => t.enabled = false); pttBtnMobile.style.display = 'flex'; btnMic.innerHTML = "ğŸ›‘ Bas-KonuÅŸ Bekliyor"; btnMic.style.background = "#e50914"; 
            } 
            else { 
                if(micStream) micStream.getAudioTracks().forEach(t => t.enabled = true); pttBtnMobile.style.display = 'none'; if(micStream) { btnMic.innerHTML = "ğŸ¤ Mikrofon AÃ§Ä±k"; btnMic.style.background = "#4CAF50"; } 
            }
        });

        document.getElementById('whisper-mode-toggle').addEventListener('change', (e) => isWhisperMode = e.target.checked);
        document.getElementById('mix-video-vol').addEventListener('input', (e) => { 
            const v = e.target.value / 100;
            videoElement.volume = v; 
            syncVideo.volume = v;
            if(ytPlayer && ytPlayer.setVolume) ytPlayer.setVolume(v * 100);
        });
        document.getElementById('mix-chat-vol').addEventListener('input', (e) => { 
            const vol = e.target.value / 100; 
            activeAudioElements.forEach(a => { 
                if(!a.muted) {
                    const pVol = peerVolumes[a.dataset.peerId] !== undefined ? peerVolumes[a.dataset.peerId] : 1;
                    a.volume = (a.dataset.whisper === 'true' ? vol * 0.3 : vol) * pVol; 
                }
            }); 
        });

        let isSpeakerMuted = false;
        btnSpeaker.addEventListener('click', () => {
            isSpeakerMuted = !isSpeakerMuted;
            if (isSpeakerMuted) { btnSpeaker.classList.add('active'); btnSpeaker.innerHTML = "ğŸ”‡ Sessiz"; activeAudioElements.forEach(a => a.muted = true); showToast("Sohbet sesleri kapatÄ±ldÄ±.", "info"); } 
            else { 
                btnSpeaker.classList.remove('active'); btnSpeaker.innerHTML = "ğŸ”Š Sohbet"; 
                const baseVol = document.getElementById('mix-chat-vol').value / 100;
                activeAudioElements.forEach(a => { 
                    a.muted = false; 
                    const pVol = peerVolumes[a.dataset.peerId] !== undefined ? peerVolumes[a.dataset.peerId] : 1;
                    a.volume = (a.dataset.whisper === 'true' ? baseVol * 0.3 : baseVol) * pVol; 
                }); 
                showToast("Sohbet sesleri aÃ§Ä±ldÄ±.", "info"); 
            }
        });

        document.getElementById('btn-refresh-devices').addEventListener('click', async () => {
            try {
                await navigator.mediaDevices.getUserMedia({audio: true}); const devices = await navigator.mediaDevices.enumerateDevices();
                const micSel = document.getElementById('mic-select'), spkSel = document.getElementById('speaker-select');
                micSel.innerHTML = '<option value="default">VarsayÄ±lan Mikrofon</option>'; spkSel.innerHTML = '<option value="default">VarsayÄ±lan HoparlÃ¶r</option>';
                devices.forEach(d => { if(d.kind === 'audioinput' && d.deviceId !== 'default') micSel.innerHTML += `<option value="${d.deviceId}">${d.label || 'Mikrofon '}</option>`; if(d.kind === 'audiooutput' && d.deviceId !== 'default') spkSel.innerHTML += `<option value="${d.deviceId}">${d.label || 'HoparlÃ¶r '}</option>`; });
                showToast("Cihazlar listelendi", "success");
            } catch(e) { showToast("Cihaz izni reddedildi!", "error"); }
        });

        document.getElementById('mic-select').addEventListener('change', (e) => selectedMicId = e.target.value);
        document.getElementById('speaker-select').addEventListener('change', (e) => { selectedSpeakerId = e.target.value; if (typeof videoElement.setSinkId !== 'undefined') { videoElement.setSinkId(selectedSpeakerId).catch(()=>{}); activeAudioElements.forEach(a => a.setSinkId(selectedSpeakerId).catch(()=>{})); } });

        function startTalking() { 
            if(!isPttMode || !micStream || isTalking) return; 
            isTalking = true; 
            micStream.getAudioTracks().forEach(t => t.enabled = true); 
            pttBtnMobile.classList.add('talking'); btnMic.innerHTML = "ğŸ™ï¸ KonuÅŸuluyor..."; btnMic.style.background = "#4CAF50"; 
        }
        function stopTalking() { 
            if(!isPttMode || !micStream || !isTalking) return; 
            isTalking = false; 
            micStream.getAudioTracks().forEach(t => t.enabled = false); 
            pttBtnMobile.classList.remove('talking'); btnMic.innerHTML = "ğŸ›‘ Bas-KonuÅŸ"; btnMic.style.background = "#e50914"; 
        }
        
        window.addEventListener('keydown', (e) => { if (e.code === 'Space' && e.target.tagName !== 'INPUT' && isPttMode && micStream) { e.preventDefault(); startTalking(); } });
        window.addEventListener('keyup', (e) => { if (e.code === 'Space' && e.target.tagName !== 'INPUT' && isPttMode) { e.preventDefault(); stopTalking(); } });
        pttBtnMobile.addEventListener('mousedown', startTalking); pttBtnMobile.addEventListener('mouseup', stopTalking); pttBtnMobile.addEventListener('mouseleave', stopTalking);
        pttBtnMobile.addEventListener('touchstart', (e) => { e.preventDefault(); startTalking(); }); pttBtnMobile.addEventListener('touchend', (e) => { e.preventDefault(); stopTalking(); });

        function showWrappedAndDisconnect() {
            if (!stats.startTime) return executeDisconnect(); 
            const durationMins = Math.max(1, Math.floor((Date.now() - stats.startTime) / 60000));
            let topChatter = "Kimse", maxMsgs = 0;
            for(const [usr, count] of Object.entries(stats.userMsgCounts)) { if(count > maxMsgs && usr !== "Sistem") { maxMsgs = count; topChatter = usr; } }
            document.getElementById('w-stat-time').innerText = durationMins; document.getElementById('w-stat-msg').innerText = stats.myMsgCount; document.getElementById('w-stat-top').innerText = topChatter; document.getElementById('w-stat-emoji').innerText = stats.emojiCount;
            
            const wContainer = document.getElementById('wrapped-overlay'); wContainer.style.display = 'flex';
            const slides = document.querySelectorAll('.w-slide'); slides.forEach(s => s.classList.remove('show'));
            let delay = 0; slides.forEach((slide, idx) => { setTimeout(() => { if(idx > 0) slides[idx-1].classList.remove('show'); slide.classList.add('show'); }, delay); delay += 3000; });
            setTimeout(() => { wContainer.style.display = 'none'; executeDisconnect(); }, delay + 1000);
        }

        let isTheaterMode = false;
        document.getElementById('btn-theater').addEventListener('click', () => { isTheaterMode = !isTheaterMode; if(isTheaterMode) { mainUiContainer.classList.add('theater-mode'); showToast("Sohbet gizlendi.", "info"); } else mainUiContainer.classList.remove('theater-mode'); });
        document.getElementById('btn-pip').addEventListener('click', async () => { try { if (document.pictureInPictureElement) await document.exitPictureInPicture(); else await videoElement.requestPictureInPicture(); } catch (err) { showToast("CihazÄ±nÄ±z PiP desteklemiyor.", "error"); } });
        let isCinemaMode = false;
        function toggleCinemaMode() { isCinemaMode = !isCinemaMode; if (isCinemaMode) { document.body.classList.add('cinema-mode'); showToast("Sinema Modu Aktif", "info"); } else document.body.classList.remove('cinema-mode'); }
        document.getElementById('btn-cinema').addEventListener('click', toggleCinemaMode); document.getElementById('btn-cinema-exit').addEventListener('click', toggleCinemaMode);

        function switchScreen(room, role) {
            document.getElementById('room-display').innerText = room; document.getElementById('role-display').innerText = role;
            document.getElementById('login-screen').classList.remove('active'); document.getElementById('video-screen').classList.add('active');
            chatMessages.innerHTML = ''; addChatMessage("Sistem", "ğŸ’»", "Odaya katÄ±ldÄ±nÄ±z. Ä°yi seyirler!", false);
            stats = { startTime: Date.now(), myMsgCount: 0, totalMsgCount: 0, emojiCount: 0, userMsgCounts: {} };
            updateMatterBounds(); 
            wakeUpZen(); 
        }

        function addChatMessage(sender, avatar, text, isMe, pId = null, uid = null) {
            const div = document.createElement('div');
            if (sender === "Sistem") div.className = `message system`; else div.className = `message ${isMe ? 'me' : ''}`;
            const avatarHtml = renderAvatarHtml(avatar);
            
            if (sender === "Sistem") { 
                div.innerHTML = `${avatarHtml} ${text}`; 
            } else { 
                div.innerHTML = `<div class="sender-info" onclick="openUserActionModal('${pId}', '${sender}', '${avatar}', '${uid}')"><span class="msg-avatar">${avatarHtml}</span> ${sender}</div><div class="msg-text">${text}</div>`; 
            }
            
            chatMessages.appendChild(div); chatMessages.scrollTop = chatMessages.scrollHeight; 
            stats.totalMsgCount++; if (isMe && sender !== "Sistem") stats.myMsgCount++; stats.userMsgCounts[sender] = (stats.userMsgCounts[sender] || 0) + 1;
            const emojiMatch = text.match(/\p{Emoji}/gu); if(emojiMatch) stats.emojiCount += emojiMatch.length;
        }

        function createVoiceAvatarElement(id, name, avatar, uid) {
            if(document.getElementById('v-avatar-'+id)) return document.getElementById('v-avatar-'+id);
            const el = document.createElement('div'); el.className = 'v-avatar'; el.id = 'v-avatar-' + id;
            el.innerHTML = `${renderAvatarHtml(avatar)} <div class="v-name">${name}</div>`;
            el.onclick = () => openUserActionModal(id, name, avatar, uid);
            document.getElementById('voice-avatars-container').appendChild(el); return el;
        }
        function removeVoiceAvatar(id) { const el = document.getElementById('v-avatar-'+id); if(el) el.remove(); activeSpeakers.delete(id); }
        function checkAudioLevels() {
            activeSpeakers.forEach((speaker) => {
                if (speaker.analyser) {
                    const dataArray = new Uint8Array(speaker.analyser.frequencyBinCount); speaker.analyser.getByteFrequencyData(dataArray);
                    let sum = 0; for(let i = 0; i < dataArray.length; i++) sum += dataArray[i];
                    let average = sum / dataArray.length;
                    if (average > 10) speaker.element.classList.add('speaking'); else speaker.element.classList.remove('speaking');
                } else if (speaker.isLocal) {
                    if (isPttMode) {
                        if (isTalking) speaker.element.classList.add('speaking'); else speaker.element.classList.remove('speaking');
                    } else {
                        speaker.element.classList.add('speaking');
                    }
                }
            });
            requestAnimationFrame(checkAudioLevels);
        }
        requestAnimationFrame(checkAudioLevels);

        function executeDisconnect() {
            if (isHost && roomCode) { remove(ref(database, 'rooms/' + roomCode)); }
            if (myStream) myStream.getTracks().forEach(t => t.stop()); if (micStream) micStream.getTracks().forEach(t => t.stop()); if(faceCamStream) faceCamStream.getTracks().forEach(t=>t.stop());
            if (peer) peer.destroy(); viewers.clear(); activeVoiceCalls.clear();
            activeAudioElements.forEach(a => a.remove()); activeAudioElements = [];
            
            globalMicEnabled = false; 

            document.getElementById('voice-avatars-container').innerHTML = ''; activeSpeakers.clear();
            document.querySelectorAll('.face-cam-bubble').forEach(e => e.remove()); window.toggleLobbyMusic(false);
            Composite.clear(physicsEngine.world); Composite.add(physicsEngine.world, physicsWalls); 

            videoElement.srcObject = null; document.getElementById('video-screen').classList.remove('active'); document.getElementById('login-screen').classList.add('active');
            document.body.classList.remove('cinema-mode'); mainUiContainer.classList.remove('theater-mode'); window.applyTheme('default'); 
            
            btnMic.classList.remove('active'); btnMic.innerHTML = "ğŸ¤ Mikrofon"; btnMic.style.background = "#444";
            btnCamera.classList.remove('active'); btnCamera.innerHTML = "ğŸ“· Kamera";
            btnSpeaker.classList.remove('active'); btnSpeaker.innerHTML = "ğŸ”Š Sohbet Sesi";
            pttBtnMobile.style.display = 'none'; isSpeakerMuted = false;
        }
        document.getElementById('leave-btn').addEventListener('click', () => { if (confirm("Odadan ayrÄ±lmak istediÄŸinize emin misiniz?")) showWrappedAndDisconnect(); });

        // Gelen Sesi Ä°ÅŸleme
        function handleIncomingVoice(call) {
            call.answer();
            call.on('stream', audioStream => {
                if (audioCtx.state === 'suspended') audioCtx.resume();
                
                const uName = call.metadata?.username || "Konuk"; 
                const uAvatar = call.metadata?.avatar || "ğŸ‘¤";
                const uUid = call.metadata?.uid || "anon";
                let analyser = null;

                if (!isMobile) {
                    const source = audioCtx.createMediaStreamSource(audioStream);
                    analyser = audioCtx.createAnalyser(); 
                    analyser.fftSize = 256; 
                    source.connect(analyser); 
                }

                const el = createVoiceAvatarElement(call.peer, uName, uAvatar, uUid); 
                activeSpeakers.set(call.peer, { analyser: analyser, element: el, isLocal: false });

                const audio = document.createElement('audio'); 
                audio.srcObject = audioStream; 
                audio.autoplay = true; 
                audio.playsInline = true; 
                audio.muted = isSpeakerMuted; 
                audio.dataset.peerId = call.peer; // Bireysel ses ayarÄ± iÃ§in kimlik
                
                const isWhisper = call.metadata?.whisper; audio.dataset.whisper = isWhisper ? 'true' : 'false';
                
                if(typeof audio.setSinkId !== 'undefined' && selectedSpeakerId !== 'default') audio.setSinkId(selectedSpeakerId).catch(()=>{});
                
                // Bireysel Ses HesaplamasÄ±
                const baseVol = document.getElementById('mix-chat-vol').value / 100; 
                const pVol = peerVolumes[call.peer] !== undefined ? peerVolumes[call.peer] : 1;
                audio.volume = (isWhisper ? baseVol * 0.3 : baseVol) * pVol;
                
                document.body.appendChild(audio); activeAudioElements.push(audio);
                
                audio.play().catch(e => console.warn("Ses otomatik oynatÄ±lamadÄ±. Cihaz etkileÅŸimi bekleniyor.", e));

                call.on('close', () => { audio.remove(); removeVoiceAvatar(call.peer); activeAudioElements = activeAudioElements.filter(a => a !== audio); });
            });
        }

        btnMic.addEventListener('click', async () => {
            if (micStream) {
                micStream.getTracks().forEach(t => t.stop()); micStream = null;
                btnMic.classList.remove('active'); btnMic.innerHTML = "ğŸ¤<span class='hide-on-mobile'> Mikrofon</span>"; btnMic.style.background = "#444";
                activeVoiceCalls.forEach(call => call.close()); activeVoiceCalls.clear(); pttBtnMobile.style.display = 'none';
                removeVoiceAvatar('local'); localAnalyser = null; 
                globalMicEnabled = false; 
                showToast("Mikrofon kapatÄ±ldÄ±.", "info");
            } else {
                try {
                    const constraints = { 
                        audio: selectedMicId !== 'default' 
                               ? { deviceId: { exact: selectedMicId }, echoCancellation: true, noiseSuppression: true, autoGainControl: true, sampleRate: 44100 } 
                               : { echoCancellation: true, noiseSuppression: true, autoGainControl: true, sampleRate: 44100 } 
                    };
                    micStream = await navigator.mediaDevices.getUserMedia(constraints);
                    
                    if(isPttMode) { micStream.getAudioTracks().forEach(t => t.enabled = false); btnMic.innerHTML = "ğŸ›‘<span class='hide-on-mobile'> Bekliyor</span>"; btnMic.style.background = "#e50914"; pttBtnMobile.style.display = 'flex'; } 
                    else { btnMic.classList.add('active'); btnMic.innerHTML = "ğŸ¤<span class='hide-on-mobile'> AÃ§Ä±k</span>"; btnMic.style.background = ""; }
                    
                    let streamToSend = applyVoiceEffect(micStream);

                    if (!isMobile) {
                        if (audioCtx.state === 'suspended') audioCtx.resume();
                        const source = audioCtx.createMediaStreamSource(micStream);
                        localAnalyser = audioCtx.createAnalyser(); localAnalyser.fftSize = 256; source.connect(localAnalyser);
                    }
                    
                    const el = createVoiceAvatarElement('local', myUsername, myAvatar, myUid); 
                    activeSpeakers.set('local', { analyser: localAnalyser, element: el, isLocal: true });
                    
                    showToast("Sese baÄŸlanÄ±ldÄ±!", "success");

                    globalMicEnabled = true; 

                    const voiceMeta = { type: 'voice', whisper: isWhisperMode, username: myUsername, avatar: myAvatar, uid: myUid };
                    if (isHost) { viewers.forEach((v, pId) => { const call = peer.call(pId, streamToSend, { metadata: voiceMeta }); activeVoiceCalls.set(pId, call); }); } 
                    else { const call = peer.call(hostId, streamToSend, { metadata: voiceMeta }); activeVoiceCalls.set(hostId, call); }
                } catch (e) { showToast("Mikrofon eriÅŸimi reddedildi!", "error"); }
            }
        });

        // Veri GÃ¶nderim Fonksiyonu
        function broadcastData(data) {
            if (isHost) viewers.forEach(v => v.conn.send(data));
            else if (hostConnection?.open) hostConnection.send(data);
        }

        const broadcastPeersList = () => { if(isHost) { const peers = Array.from(viewers.keys()); viewers.forEach(v => v.conn.send({ type: 'PEER_LIST', peers: peers.filter(p => p !== v.conn.peer) })); } };

        function handleIncomingData(data, conn = null) {
            if (data.type === 'CHAT') { addChatMessage(data.sender, data.avatar, data.text, false, data.peerId, data.uid); if (isHost && conn) viewers.forEach(v => { if (v.conn.peer !== conn.peer) v.conn.send(data); }); } 
            else if (data.type === 'PHYSICS_EMOJI') { 
                const dropX = data.xRatio * matterCanvas.width; const dropY = data.yRatio * matterCanvas.height;
                spawnPhysicsEmoji(data.emoji, dropX, dropY, data.vx, data.vy, false);
                if (isHost && conn) viewers.forEach(v => { if (v.conn.peer !== conn.peer) v.conn.send(data); });
            }
            else if (data.type === 'SYNC_MEDIA_START' || data.type === 'SYNC_MEDIA_STOP' || data.type === 'SYNC_MEDIA') {
                handleIncomingSyncCommand(data);
                if (isHost && conn) viewers.forEach(v => { if (v.conn.peer !== conn.peer) v.conn.send(data); });
            }
            else if (data.type === 'CLEAR_CHAT') { chatMessages.innerHTML = ''; showToast("Sohbet temizlendi.", "info"); }
            else if (data.type === 'KICK') { showToast("Odadan atÄ±ldÄ±nÄ±z!", "error"); setTimeout(showWrappedAndDisconnect, 1000); }
            else if (data.type === 'ADMIN_MSG') { window.showAdminAnnouncement(data.text); }
            else if (data.type === 'THEME') { window.applyTheme(data.theme); } 
            else if (data.type === 'LOBBY_MUSIC') { window.toggleLobbyMusic(data.state); }
            else if (data.type === 'PEER_LIST') { otherPeers = data.peers; }
            else if (data.type === 'FACECAM_OFF') { document.getElementById('facecam-'+data.peerId)?.remove(); if (isHost) viewers.forEach(v => { if(v.conn.peer !== conn.peer) v.conn.send(data); }); }
            else if (data.type === 'EFFECT') { window.triggerEffect(data.effect); if (isHost && conn) viewers.forEach(v => { if (v.conn.peer !== conn.peer) v.conn.send(data); }); }
            else if (data.type === 'HOST_TRANSFER') { if (peer.id === data.newHostId) { window.becomeHost('sync'); } else { window.connectToNewHost(data.newHostId); } }
        }

        function setupPeerListeners() {
            peer.on('call', call => {
                if (call.metadata?.type === 'screen') {
                    call.answer(); call.on('stream', rStream => { videoElement.srcObject = rStream; statusText.innerText = "BaÄŸlÄ±"; videoElement.onloadedmetadata = () => videoElement.play().catch(() => playOverlay.style.display = 'flex'); });
                } else if (call.metadata?.type === 'voice') { handleIncomingVoice(call); }
                else if (call.metadata?.type === 'facecam') {
                    call.answer(); call.on('stream', s => { createFaceCamUI(call.peer, call.metadata.username, s, false); });
                    call.on('close', () => { document.getElementById('facecam-'+call.peer)?.remove(); });
                }
            });

            peer.on('connection', conn => {
                conn.on('open', () => {
                    if (!isHost) return; 
                    const uname = conn.metadata?.username || "Anonim", uavatar = conn.metadata?.avatar || "ğŸ‘¤", uuid = conn.metadata?.uid || "anon";
                    viewers.set(conn.peer, { conn: conn, username: uname, avatar: uavatar, uid: uuid });
                    updateAdminPanel(); showToast(`${uname} odaya katÄ±ldÄ±!`, "success"); broadcastPeersList();

                    if(currentTheme !== 'default') conn.send({ type: 'THEME', theme: currentTheme });
                    if(isLobbyMusicPlaying) conn.send({ type: 'LOBBY_MUSIC', state: true });
                    
                    // Medya senkronu varsa yeni gelene bildir
                    if(syncActive) {
                        const ytUrl = ytPlayer && ytPlayer.getVideoUrl ? ytPlayer.getVideoUrl() : null;
                        const vUrl = syncVideo.src;
                        conn.send({ type: 'SYNC_MEDIA_START', url: ytUrl || vUrl });
                    }

                    if (myStream) peer.call(conn.peer, myStream, { metadata: { type: 'screen' } });
                    if (micStream) { 
                        let streamToSend = applyVoiceEffect(micStream);
                        const voiceMeta = { type: 'voice', whisper: isWhisperMode, username: myUsername, avatar: myAvatar, uid: myUid }; 
                        const vCall = peer.call(conn.peer, streamToSend, { metadata: voiceMeta }); 
                        activeVoiceCalls.set(conn.peer, vCall); 
                    }
                    if (faceCamStream) { myFaceCamCalls.push(peer.call(conn.peer, faceCamStream, { metadata: { type: 'facecam', username: myUsername, uid: myUid } })); }
                });

                conn.on('data', data => handleIncomingData(data, conn));
                conn.on('close', () => { 
                    if (!isHost) return; const vData = viewers.get(conn.peer); if(vData) showToast(`${vData.username} odadan ayrÄ±ldÄ±.`, "info");
                    viewers.delete(conn.peer); updateAdminPanel(); broadcastPeersList();
                });
            });
        }

        window.startHostingProcess = async (mode) => {
            roomCode = document.getElementById('room-input').value.trim(); myUsername = document.getElementById('username-input').value.trim() || "YayÄ±ncÄ±";
            if(!roomCode) return showToast("LÃ¼tfen Oda Kodu girin!", "error");

            isHost = true; document.getElementById('admin-panel').style.display = 'block'; 

            if (mode === 'screen') {
                if (isMobile) return showToast("Ekran paylaÅŸÄ±mÄ± mobilde desteklenmiyor.", "error");
                try {
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getDisplayMedia) throw new Error("API Desteklenmiyor");
                    myStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
                } catch (err) {
                    try { myStream = await navigator.mediaDevices.getDisplayMedia({ video: true }); showToast("Sistem sesi aktarÄ±lamÄ±yor, sessiz yayÄ±n baÅŸladÄ±.", "info"); } 
                    catch (err2) {
                        showToast("Ekran paylaÅŸÄ±mÄ± reddedildi.", "error"); return;
                    }
                }
                videoElement.srcObject = myStream; videoElement.muted = true;
                videoElement.style.display = 'block'; syncMediaContainer.style.display = 'none';
                if(myStream.getVideoTracks().length > 0) myStream.getVideoTracks()[0].onended = () => { showToast("PaylaÅŸÄ±m durduruldu.", "error"); showWrappedAndDisconnect(); };
            } else {
                myStream = null;
                videoElement.style.display = 'none'; syncMediaContainer.style.display = 'block';
                document.getElementById('sync-media-modal').classList.add('active');
            }

            peer = new Peer(); 
            peer.on('open', (id) => { 
                hostId = id;
                set(ref(database, 'rooms/' + roomCode), { hostId: hostId, hostName: myUsername, createdAt: serverTimestamp() });
                statusText.innerText = "YayÄ±n Aktif!"; switchScreen(roomCode, "YayÄ±ncÄ±"); showToast("Oda baÅŸarÄ±yla kuruldu.", "success"); 
                window.applyTheme(currentTheme); 
            });
            setupPeerListeners();
        };

        document.getElementById('btn-host-screen').addEventListener('click', () => startHostingProcess('screen'));
        document.getElementById('btn-host-sync-menu').addEventListener('click', () => startHostingProcess('sync'));

        window.connectToNewHost = function(targetHostId) {
            statusText.innerText = "BaÄŸlanÄ±yor..."; if (hostConnection) hostConnection.close();
            hostConnection = peer.connect(targetHostId, { metadata: { username: myUsername, avatar: myAvatar, uid: myUid } });
            hostConnection.on('open', () => { statusText.innerText = "GÃ¶rÃ¼ntÃ¼ bekleniyor..."; showToast("YayÄ±ncÄ±ya baÄŸlanÄ±ldÄ±!", "success"); });
            hostConnection.on('data', handleIncomingData);
            
            if (micStream) { 
                let streamToSend = applyVoiceEffect(micStream);
                const voiceMeta = { type: 'voice', whisper: isWhisperMode, username: myUsername, avatar: myAvatar, uid: myUid }; 
                activeVoiceCalls.set(targetHostId, peer.call(targetHostId, streamToSend, { metadata: voiceMeta })); 
            }
            if (faceCamStream) { const camMeta = { type: 'facecam', username: myUsername, uid: myUid }; myFaceCamCalls.push(peer.call(targetHostId, faceCamStream, { metadata: camMeta })); }
        };

        document.getElementById('btn-viewer').addEventListener('click', () => {
            roomCode = document.getElementById('room-input').value.trim(); myUsername = document.getElementById('username-input').value.trim() || "Ä°zleyici";
            if(!roomCode) return showToast("LÃ¼tfen Oda Kodu girin!", "error");
            isHost = false; document.getElementById('admin-panel').style.display = 'none';

            get(ref(database, 'rooms/' + roomCode)).then((snapshot) => {
                if(!snapshot.exists()) return showToast("BÃ¶yle bir oda bulunamadÄ±!", "error");
                hostId = snapshot.val().hostId;
                
                statusText.innerText = "BaÄŸlanÄ±lÄ±yor...";
                switchScreen(roomCode, "Ä°zleyici");
                
                peer = new Peer(); 
                peer.on('open', () => { statusText.innerText = "YayÄ±ncÄ± aranÄ±yor..."; window.connectToNewHost(hostId); });
                setupPeerListeners();
                peer.on('error', err => { if (err.type === 'peer-unavailable') { showToast("YayÄ±ncÄ±ya ulaÅŸÄ±lamÄ±yor!", "error"); setTimeout(executeDisconnect, 2000); } });
                
            }).catch(error => showToast("Oda kontrol edilemedi.", "error"));
        });

        document.getElementById('force-play-btn').addEventListener('click', () => { playOverlay.style.display = 'none'; videoElement.play(); if(syncActive && !isHost) syncVideo.play(); });

        function sendMessage() {
            const text = chatInput.value.trim(); if(!text) return;
            if (text.startsWith('/')) {
                if (!isHost) { showToast("Bu komutlarÄ± sadece oda kurucusu kullanabilir!", "error"); chatInput.value = ''; return; }
                if (text === '/zar' || text === '/roll') { const dice = Math.floor(Math.random() * 6) + 1; const msg = `ğŸ² Zar atÄ±ldÄ± ve ${dice} geldi!`; const msgData = { type: 'CHAT', sender: "Sistem", avatar: "ğŸ¤–", text: msg }; broadcastData(msgData); addChatMessage("Sistem", "ğŸ¤–", msg, false); chatInput.value = ''; return; }
                if (text.startsWith('/admin ')) { const msg = text.replace('/admin ', ''); const msgData = { type: 'ADMIN_MSG', text: msg }; broadcastData(msgData); window.showAdminAnnouncement(msg); chatInput.value = ''; return; }
                if (text === '/korku' || text === '/boo') { window.triggerEffect('scare'); broadcastData({ type: 'EFFECT', effect: 'scare' }); chatInput.value = ''; return; }
                if (text === '/party') { window.triggerEffect('party'); broadcastData({ type: 'EFFECT', effect: 'party' }); chatInput.value = ''; return; }
                showToast("GeÃ§ersiz komut!", "error"); return;
            }
            const msgData = { type: 'CHAT', sender: myUsername, avatar: myAvatar, text: text, peerId: (peer?peer.id:''), uid: myUid };
            broadcastData(msgData);
            addChatMessage(myUsername, myAvatar, text, true, (peer?peer.id:''), myUid);
            chatInput.value = '';
        }

        document.getElementById('chat-send-btn').addEventListener('click', sendMessage);
        document.getElementById('chat-input').addEventListener('keypress', (e) => { if(e.key === 'Enter') sendMessage(); });

        window.becomeHost = async function(mode = 'screen') {
            isHost = true; document.getElementById('admin-panel').style.display = 'block';
            if (hostConnection) hostConnection.close(); showToast("YayÄ±ncÄ± yetkisi size geÃ§ti! LÃ¼tfen yayÄ±nÄ± baÅŸlatÄ±n.", "success");
            
            if (mode === 'screen') {
                try { myStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true }); } catch (err) { try { myStream = await navigator.mediaDevices.getDisplayMedia({ video: true }); } catch (err2) { return showToast("Ekran paylaÅŸÄ±m izni verilmedi!", "error"); } }
                videoElement.srcObject = myStream; videoElement.muted = true; 
            } else {
                myStream = null; videoElement.style.display = 'none'; syncMediaContainer.style.display = 'block';
                document.getElementById('sync-media-modal').classList.add('active');
            }
            document.getElementById('role-display').innerText = "YayÄ±ncÄ±";
        };

        window.transferHost = function(targetPeerId) {
            const t = viewers.get(targetPeerId);
            if(t && confirm(`${t.username} adlÄ± kullanÄ±cÄ±yÄ± yeni YayÄ±ncÄ± yapmak istiyor musunuz?`)) {
                set(ref(database, 'rooms/' + roomCode), { hostId: targetPeerId, hostName: t.username, createdAt: serverTimestamp() }).then(() => {
                    broadcastData({ type: 'HOST_TRANSFER', newHostId: targetPeerId });
                    isHost = false; document.getElementById('admin-panel').style.display = 'none';
                    if (myStream) myStream.getTracks().forEach(track => track.stop()); myStream = null;
                    viewers.clear(); document.getElementById('role-display').innerText = "Ä°zleyici"; window.connectToNewHost(targetPeerId);
                });
            }
        };

        function updateAdminPanel() {
            const list = document.getElementById('admin-user-list'); list.innerHTML = '';
            viewers.forEach((v, peerId) => {
                const li = document.createElement('li'); li.className = 'admin-user-item';
                li.innerHTML = `<span><div style="width:20px;height:20px;display:inline-block;border-radius:50%;overflow:hidden;vertical-align:middle;">${renderAvatarHtml(v.avatar)}</div> ${v.username}</span> <div><button class="kick-btn" style="background:#2196F3;" onclick="window.transferHost('${peerId}')">Devret</button> <button class="kick-btn" onclick="window.kickUser('${peerId}')">At</button></div>`;
                list.appendChild(li);
            });
        }
        window.kickUser = function(pId) { const t = viewers.get(pId); if(t && confirm(`${t.username} atÄ±lsÄ±n mÄ±?`)) { t.conn.send({ type: 'KICK' }); setTimeout(() => t.conn.close(), 500); } };
        document.getElementById('btn-clear-chat').addEventListener('click', () => { if(confirm("Sohbeti sil?")) { chatMessages.innerHTML = ''; broadcastData({ type: 'CLEAR_CHAT' }); showToast("Sohbet temizlendi.", "info"); } });
    </script>
</body>
</html>