<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ¿ Comba Watch Party Ultimate</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --primary: #e50914; --primary-hover: #b20710; --bg-color: #0f0f0f; --card-bg: #1e1e1e; --text-color: #f1f1f1; --border-color: #333; }
        body { margin: 0; font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; background-color: var(--bg-color); color: var(--text-color); overflow-x: hidden; }
        * { box-sizing: border-box; }
        .screen { display: none; }
        .screen.active { display: flex; }
        
        /* Toast Bildirimleri */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 999999; display: flex; flex-direction: column; gap: 10px; pointer-events: none;}
        .toast { background: #2a2a2a; color: #fff; padding: 12px 18px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.6); border-left: 4px solid var(--primary); font-size: 0.9rem; font-weight: 500; transform: translateX(120%); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: flex; align-items: center; gap: 10px; max-width: 300px; }
        .toast.show { transform: translateX(0); }
        .toast.success { border-left-color: #4CAF50; }
        .toast.error { border-left-color: #f44336; }
        .toast.info { border-left-color: #2196F3; }
        
        /* Ayarlar ModalÄ± */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 99999; padding: 20px; }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--card-bg); padding: 25px; border-radius: 12px; width: 100%; max-width: 420px; box-shadow: 0 10px 40px rgba(0,0,0,0.8); max-height: 90vh; overflow-y: auto; }
        .modal h2 { margin-top: 0; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; font-size: 1.2rem; display: flex; justify-content: space-between; align-items: center; }
        .setting-group { margin-bottom: 15px; background: #141414; padding: 12px; border-radius: 8px; border: 1px solid #2a2a2a; }
        .setting-group label { display: block; margin-bottom: 8px; color: #aaa; font-size: 0.85rem; font-weight: bold; text-transform: uppercase; }
        .setting-group select, .setting-group input[type="range"] { width: 100%; padding: 10px; border-radius: 6px; background: #2a2a2a; border: 1px solid var(--border-color); color: white; outline: none; }
        .avatar-selector { display: flex; gap: 8px; flex-wrap: wrap; }
        .avatar-option { font-size: 1.5rem; cursor: pointer; padding: 8px; border-radius: 8px; border: 2px solid transparent; transition: 0.2s; background: #2a2a2a; }
        .avatar-option.selected { border-color: var(--primary); background: #3a3a3a; transform: scale(1.1); }
        .modal-close { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 10px; }

        /* GiriÅŸ EkranÄ± */
        #login-screen { height: 100vh; justify-content: center; align-items: center; padding: 20px; flex-direction: column; gap: 20px;}
        .card { background: var(--card-bg); padding: 35px; border-radius: 16px; text-align: center; width: 100%; max-width: 400px; box-shadow: 0 15px 50px rgba(0,0,0,0.6); border: 1px solid #2a2a2a; }
        .card h1 { margin-top: 0; color: var(--primary); font-size: 2rem; margin-bottom: 5px; }
        .card p { color: #888; margin-bottom: 25px; font-size: 0.9rem; }
        .card input { width: 100%; padding: 14px; margin: 8px 0; border: 1px solid var(--border-color); border-radius: 8px; background: #141414; color: white; font-size: 1rem; text-align: center; outline: none; transition: 0.2s; }
        .card input:focus { border-color: var(--primary); }
        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        .card button { flex: 1; padding: 14px; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; transition: 0.2s; }
        #btn-host { background: var(--primary); } #btn-host:hover { background: var(--primary-hover); }
        #btn-viewer { background: #2196F3; } #btn-viewer:hover { background: #1976D2; }
        #btn-open-login-settings { background: #333; width: 100%; margin-top: 10px; }
        
        /* Ana Ekran DÃ¼zeni (PC) */
        .main-container { display: flex; width: 100vw; height: 100vh; transition: 0.3s; }
        .video-section { flex: 3; display: flex; flex-direction: column; background: #000; position: relative; transition: flex 0.3s; }
        .header { background: #141414; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); }
        .header-left h2 { margin: 0; font-size: 1.1rem; color: #fff; font-weight: 600; }
        .header-controls { display: flex; gap: 8px; flex-wrap: wrap; }
        
        .ctrl-btn { padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85rem; color: white; transition: 0.2s; display: flex; align-items: center; gap: 5px; }
        .ctrl-btn.theater { background: #0288d1; } .ctrl-btn.pip { background: #00796b; } .ctrl-btn.cinema { background: #673ab7; }
        .ctrl-btn.mic { background: #444; } .ctrl-btn.mic.active { background: #e50914; animation: pulse 1.5s infinite; }
        .ctrl-btn.speaker { background: #444; } .ctrl-btn.speaker.active { background: #ff9800; }
        .ctrl-btn.settings { background: #333; } .ctrl-btn.leave { background: #2a2a2a; border: 1px solid #555; }
        .ctrl-btn:hover { filter: brightness(1.2); }

        .video-wrapper { flex: 1; position: relative; display: flex; justify-content: center; align-items: center; background: #000; overflow: hidden; }
        #main-video { width: 100%; height: 100%; object-fit: contain; max-height: calc(100vh - 65px); outline: none; }
        
        #play-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.85); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 10; backdrop-filter: blur(5px); }
        #play-overlay h2 { color: var(--primary); font-size: 1.8rem; margin-bottom: 10px; }
        #play-overlay button { padding: 12px 35px; font-size: 1.1rem; background: var(--primary); color: white; border: none; border-radius: 50px; cursor: pointer; margin-top: 15px; font-weight: bold; }

        /* UÃ‡UÅAN EMOJÄ°LER VE REAKSÄ°YON BARI */
        .reaction-bar { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(20, 20, 20, 0.8); backdrop-filter: blur(10px); padding: 8px 15px; border-radius: 30px; display: flex; gap: 15px; z-index: 100; border: 1px solid rgba(255,255,255,0.1); }
        .reaction-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; transition: transform 0.2s; padding: 0; }
        .reaction-btn:hover { transform: scale(1.3); }
        #floating-emoji-container { position: absolute; inset: 0; pointer-events: none; z-index: 99; overflow: hidden; }
        .floating-emoji { position: absolute; bottom: 50px; font-size: 2rem; opacity: 1; animation: floatUp 2.5s ease-out forwards; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        @keyframes floatUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 50% { transform: translateY(-150px) scale(1.5) translateX(20px); opacity: 0.8; } 100% { transform: translateY(-300px) scale(1); opacity: 0; } }

        /* Sohbet Paneli (PC) */
        .sidebar { flex: 1; background: #141414; border-left: 1px solid var(--border-color); display: flex; flex-direction: column; max-width: 350px; transition: 0.3s transform, 0.3s opacity, 0.3s max-width; }
        .sidebar-header { padding: 15px; background: #1a1a1a; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .sidebar-header h3 { margin: 0; font-size: 1rem; color: #ddd; }
        
        .chat-messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; background: #0f0f0f; }
        .message { background: #222; padding: 10px 12px; border-radius: 10px; font-size: 0.9rem; line-height: 1.4; align-self: flex-start; max-width: 85%; word-wrap: break-word; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .message.me { background: #1a365d; align-self: flex-end; border-bottom-right-radius: 2px; }
        .message:not(.me) { border-bottom-left-radius: 2px; }
        .message .sender-info { display: flex; align-items: center; gap: 6px; font-weight: 600; color: #aaa; font-size: 0.75rem; margin-bottom: 4px; }
        .message.me .sender-info { color: #90caf9; }
        .msg-avatar { font-size: 1.1rem; }
        
        .chat-input-area { padding: 12px; background: #1a1a1a; border-top: 1px solid var(--border-color); display: flex; gap: 8px; }
        #chat-input { flex: 1; padding: 12px; border-radius: 20px; border: 1px solid #333; background: #222; color: white; outline: none; font-size: 0.9rem; }
        #chat-send-btn { padding: 0 18px; background: var(--primary); color: white; border: none; border-radius: 20px; cursor: pointer; font-weight: bold; }

        /* Admin Paneli */
        #admin-panel { display: none; background: #1e1e1e; border-top: 1px solid var(--border-color); padding: 15px; }
        #admin-panel h4 { margin: 0 0 10px 0; color: #ffeb3b; display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; }
        #btn-clear-chat { padding: 4px 10px; background: #444; border: none; color: white; border-radius: 4px; cursor: pointer; font-size: 0.75rem; }
        #admin-user-list { list-style: none; padding: 0; margin: 0; max-height: 120px; overflow-y: auto; }
        .admin-user-item { display: flex; justify-content: space-between; align-items: center; background: #111; padding: 8px 10px; margin-bottom: 5px; border-radius: 6px; font-size: 0.85rem; }
        .kick-btn { background: #e50914; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.75rem; font-weight: bold; }

        /* MODLAR (Tiyatro & Sinema) */
        .main-container.theater-mode .sidebar { max-width: 0; opacity: 0; overflow: hidden; border: none; padding: 0; }
        body.cinema-mode .sidebar { display: none; }
        body.cinema-mode .header { display: none; }
        body.cinema-mode .video-section { position: fixed; inset: 0; z-index: 9999; background: #000; }
        body.cinema-mode #main-video { max-height: 100vh; }
        #btn-cinema-exit { display: none; position: fixed; top: 20px; right: 20px; z-index: 10000; background: rgba(229, 9, 20, 0.9); padding: 10px 20px; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        body.cinema-mode #btn-cinema-exit { display: block; }

        /* Bas KonuÅŸ Mobil Butonu */
        #ptt-btn-mobile { position: fixed; bottom: 80px; right: 20px; z-index: 99999; width: 70px; height: 70px; border-radius: 50%; background: rgba(229, 9, 20, 0.9); color: white; border: 3px solid #fff; font-size: 30px; display: none; justify-content: center; align-items: center; box-shadow: 0 5px 20px rgba(0,0,0,0.5); user-select: none; -webkit-user-select: none; transition: 0.2s; }
        #ptt-btn-mobile.talking { background: #4CAF50; transform: scale(1.1); box-shadow: 0 0 20px #4CAF50; }

        /* SPOTIFY WRAPPED (Ã–ZET) EKRANI */
        #wrapped-overlay { position: fixed; inset: 0; z-index: 9999999; background: linear-gradient(135deg, #e50914, #4a00e0); display: none; flex-direction: column; justify-content: center; align-items: center; color: white; text-align: center; overflow: hidden; }
        .w-slide { position: absolute; opacity: 0; transform: translateY(50px); transition: all 0.8s ease-out; font-size: 1.8rem; width: 90%; max-width: 600px; }
        .w-slide.show { opacity: 1; transform: translateY(0); }
        .w-title { font-size: 2.5rem; font-weight: 900; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 2px; text-shadow: 2px 2px 10px rgba(0,0,0,0.5); }
        .w-highlight { color: #ffd700; font-size: 4.5rem; display: block; margin: 15px 0; font-weight: 900; text-shadow: 0 0 20px rgba(255, 215, 0, 0.5); }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* MOBÄ°L TASARIM (Responsive) */
        @media (max-width: 768px) {
            .main-container { flex-direction: column; height: 100dvh; } 
            .header { padding: 10px; flex-direction: column; align-items: flex-start; gap: 10px; }
            .header-left h2 { font-size: 1rem; }
            .header-controls { width: 100%; overflow-x: auto; padding-bottom: 5px; flex-wrap: nowrap; -webkit-overflow-scrolling: touch; }
            .header-controls::-webkit-scrollbar { height: 4px; }
            .header-controls::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }
            .ctrl-btn { flex-shrink: 0; padding: 8px 15px; font-size: 0.8rem; }
            .video-section { flex: none; height: auto; }
            .video-wrapper { aspect-ratio: 16/9; max-height: 40vh; }
            #main-video { max-height: none; }
            .sidebar { max-width: 100%; flex: 1; border-left: none; border-top: 1px solid var(--border-color); height: auto; }
            .chat-messages { padding: 10px; }
            .chat-input-area { padding: 10px; padding-bottom: max(10px, env(safe-area-inset-bottom)); } 
            #btn-theater { display: none; } 
            #ptt-btn-mobile { bottom: 100px; }
            .reaction-bar { bottom: 10px; padding: 5px 10px; gap: 10px; }
            .reaction-btn { font-size: 1.2rem; }
        }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <div id="wrapped-overlay">
        <div class="w-slide">
            <div class="w-title">Gecenin Ã–zeti ğŸ¿</div>
            <p style="font-size: 1.2rem;">Zaman Ã§ok hÄ±zlÄ± akÄ±yor...</p>
        </div>
        <div class="w-slide">Beraber tam <span class="w-highlight" id="w-stat-time">0</span> dakika film izlediniz!</div>
        <div class="w-slide">Sohbete sen <span class="w-highlight" id="w-stat-msg">0</span> mesaj gÃ¶nderdin.</div>
        <div class="w-slide">OdanÄ±n en gevezesi: <span class="w-highlight" id="w-stat-top">Kimse</span></div>
        <div class="w-slide">
            AyrÄ±ca sohbette toplam <span class="w-highlight" id="w-stat-emoji">0</span> emoji kullandÄ±nÄ±z! <br>
            <span style="font-size: 1.2rem; color: #ddd;">Harika bir yayÄ±n partisiydi, tekrar gÃ¶rÃ¼ÅŸmek Ã¼zere...</span>
        </div>
    </div>

    <div class="modal-overlay" id="settings-modal">
        <div class="modal">
            <h2>âš™ï¸ Profil & Ayarlar <button id="btn-logout" style="background:#444; color:#fff; border:none; padding:5px 10px; border-radius:4px; cursor:pointer; font-size:0.8rem; display:none;">Ã‡Ä±kÄ±ÅŸ Yap</button></h2>
            <div class="setting-group">
                <label>Profil AvatarÄ±</label>
                <div class="avatar-selector">
                    <div class="avatar-option selected">ğŸ‘¤</div><div class="avatar-option">ğŸ¦Š</div>
                    <div class="avatar-option">ğŸ±</div><div class="avatar-option">ğŸ¼</div>
                    <div class="avatar-option">ğŸ¦</div><div class="avatar-option">ğŸ¸</div>
                    <div class="avatar-option">ğŸ‘½</div><div class="avatar-option">ğŸ‘»</div>
                </div>
            </div>
            
            <div class="setting-group">
                <label>ğŸ™ï¸ Ä°letiÅŸim Modu</label>
                <select id="voice-mode-select">
                    <option value="continuous">SÃ¼rekli AÃ§Ä±k Mikrofon</option>
                    <option value="ptt">Bas-KonuÅŸ (Space TuÅŸu / Mobil Buton)</option>
                </select>
                <label style="display:flex; align-items:center; gap:8px; cursor:pointer; margin-top:10px; color:#fff; text-transform:none;">
                    <input type="checkbox" id="whisper-mode-toggle" style="width:auto; transform: scale(1.2);">
                    FÄ±sÄ±ltÄ± Modu (Sesimi kÄ±sÄ±k ilet)
                </label>
            </div>

            <div class="setting-group">
                <label>ğŸ”Š Ses KarÄ±ÅŸtÄ±rÄ±cÄ±</label>
                <span style="font-size:0.8rem; color:#888;">Film Sesi</span>
                <input type="range" id="mix-video-vol" min="0" max="100" value="100">
                <span style="font-size:0.8rem; color:#888; display:block; margin-top:5px;">Sohbet Sesi</span>
                <input type="range" id="mix-chat-vol" min="0" max="100" value="100">
            </div>

            <div class="setting-group">
                <label>ğŸ¤ Cihaz SeÃ§imi</label>
                <button id="btn-refresh-devices" class="ctrl-btn settings" style="margin-bottom:8px; width:100%; justify-content:center;">CihazlarÄ± Yenile</button>
                <select id="mic-select"><option value="default">VarsayÄ±lan Mikrofon</option></select>
                <select id="speaker-select" style="margin-top:8px;"><option value="default">VarsayÄ±lan HoparlÃ¶r</option></select>
            </div>
            <button class="modal-close" id="btn-close-settings">Kaydet ve Kapat</button>
        </div>
    </div>

    <div id="ptt-btn-mobile" title="KonuÅŸmak iÃ§in basÄ±lÄ± tut">ğŸ™ï¸</div>

    <div id="login-screen" class="screen active">
        <div class="card" id="auth-card">
            <h1>ğŸ¿ Comba Watch Party</h1>
            <p>Devam etmek iÃ§in giriÅŸ yapÄ±n</p>
            <input type="email" id="email-input" placeholder="E-posta Adresin">
            <input type="password" id="password-input" placeholder="Åifren">
            <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 15px;">
                <button id="btn-email-login" style="background: var(--primary); padding: 12px; border:none; color:white; border-radius:6px; cursor:pointer; font-weight:bold;">GiriÅŸ Yap / KayÄ±t Ol</button>
                <button id="btn-google-login" style="background: #fff; color: #333; padding: 12px; border:none; border-radius:6px; cursor:pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" alt="Google" style="width:20px;"> Google ile GiriÅŸ Yap
                </button>
            </div>
        </div>

        <div class="card" id="room-controls" style="display: none;">
            <h1>ğŸ¿ Comba Watch Party</h1>
            <p>HoÅŸ geldin, <span id="display-username" style="color:var(--primary); font-weight:bold;"></span>!</p>
            <input type="text" id="username-input" placeholder="GÃ¶rÃ¼nen AdÄ±n (Ã–rn: PamcÄ±k)">
            <input type="text" id="room-input" placeholder="Oda Kodu (Ã–rn: 1234)">
            <button id="btn-open-login-settings" class="ctrl-btn settings" style="justify-content:center;">âš™ï¸ Profilini Ayarla</button>
            <div class="btn-group">
                <button id="btn-host">YayÄ±ncÄ± Ol</button>
                <button id="btn-viewer">Ä°zleyici Ol</button>
            </div>
        </div>
    </div>

    <div id="video-screen" class="screen">
        <button id="btn-cinema-exit">âŒ Sinemadan Ã‡Ä±k</button>
        <div class="main-container" id="main-ui-container">
            <div class="video-section">
                <div class="header">
                    <div class="header-left">
                        <h2>ğŸ¿ Oda: <span id="room-display">...</span> (<span id="role-display">...</span>)</h2>
                    </div>
                    <div class="header-controls">
                        <button id="btn-theater" class="ctrl-btn theater" title="Sohbeti Daralt/GeniÅŸlet">â†”ï¸ Tiyatro</button>
                        <button id="btn-pip" class="ctrl-btn pip" title="Pencere Ä°Ã§inde Pencere">ğŸ“º PiP</button>
                        <button id="btn-cinema" class="ctrl-btn cinema" title="IÅŸÄ±klarÄ± Kapat">ğŸ¬ Sinema</button>
                        <button id="btn-speaker" class="ctrl-btn speaker" title="ArkadaÅŸlarÄ±n sesini kapat">ğŸ”Š Sohbet Sesi</button>
                        <button id="btn-mic" class="ctrl-btn mic" title="Mikrofonu Kapat/AÃ§">ğŸ¤ Mikrofon</button>
                        <button id="btn-settings" class="ctrl-btn settings" title="Ayarlar">âš™ï¸</button>
                        <button id="leave-btn" class="ctrl-btn leave">Ã‡Ä±kÄ±ÅŸ</button>
                    </div>
                </div>
                
                <div class="video-wrapper">
                    <video id="main-video" controls autoplay playsinline></video>
                    <div id="play-overlay">
                        <h2>ğŸ¿ YayÄ±n Aktif</h2>
                        <p>Sesi aÃ§mak ve yayÄ±na katÄ±lmak iÃ§in tÄ±klayÄ±n.</p>
                        <button id="force-play-btn">â–¶ BaÅŸlat</button>
                    </div>

                    <div id="floating-emoji-container"></div>
                    <div class="reaction-bar">
                        <button class="reaction-btn" onclick="window.sendReaction('ğŸ˜‚')">ğŸ˜‚</button>
                        <button class="reaction-btn" onclick="window.sendReaction('ğŸ˜')">ğŸ˜</button>
                        <button class="reaction-btn" onclick="window.sendReaction('ğŸ˜®')">ğŸ˜®</button>
                        <button class="reaction-btn" onclick="window.sendReaction('ğŸ˜­')">ğŸ˜­</button>
                        <button class="reaction-btn" onclick="window.sendReaction('ğŸ”¥')">ğŸ”¥</button>
                        <button class="reaction-btn" onclick="window.sendReaction('ğŸ¿')">ğŸ¿</button>
                    </div>
                </div>
            </div>

            <div class="sidebar">
                <div class="sidebar-header">
                    <h3>ğŸ’¬ Lobi Sohbeti</h3>
                    <span id="status-text" style="color:#4CAF50; font-size: 0.8rem; font-weight:bold;">BaÄŸlanÄ±lÄ±yor...</span>
                </div>
                <div class="chat-messages" id="chat-messages"></div>
                <div id="admin-panel">
                    <h4>ğŸ‘‘ Admin MenÃ¼sÃ¼ <button id="btn-clear-chat">Sohbeti Temizle</button></h4>
                    <ul id="admin-user-list"></ul>
                </div>
                <div class="chat-input-area">
                    <input type="text" id="chat-input" placeholder="Mesaj yaz...">
                    <button id="chat-send-btn">GÃ¶nder</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase ModÃ¼lleri
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
        import { getDatabase, ref, set, get, remove, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";

        // Senin Firebase YapÄ±landÄ±rman
        const firebaseConfig = {
            apiKey: "AIzaSyAUh4qKPlNo7K9j6VtKVUHrp8PwaBpa7WE",
            authDomain: "survivor-d69a5.firebaseapp.com",
            databaseURL: "https://survivor-d69a5-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "survivor-d69a5",
            storageBucket: "survivor-d69a5.firebasestorage.app",
            messagingSenderId: "998975421906",
            appId: "1:998975421906:web:972c493b782cce9576dc0b",
            measurementId: "G-VRR63HL878"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        // --- Ä°STATÄ°STÄ°KLER (WRAPPED Ä°Ã‡Ä°N) ---
        let stats = { startTime: 0, myMsgCount: 0, totalMsgCount: 0, emojiCount: 0, userMsgCounts: {} };

        // --- TOAST BÄ°LDÄ°RÄ°MLERÄ° ---
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const icon = type === 'success' ? 'âœ…' : (type === 'error' ? 'âš ï¸' : 'â„¹ï¸');
            toast.innerHTML = `<span>${icon}</span> <span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 3000);
        }

        // --- GLOBAL DEÄÄ°ÅKENLER ---
        let peer = null, myStream = null, micStream = null;
        let isHost = false, myUsername = "Anonim", myAvatar = "ğŸ‘¤", roomCode = "", hostId = "";
        let hostConnection = null, viewers = new Map(), activeVoiceCalls = new Map(), activeAudioElements = []; 

        const videoElement = document.getElementById('main-video');
        const playOverlay = document.getElementById('play-overlay');
        const statusText = document.getElementById('status-text');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        
        const btnMic = document.getElementById('btn-mic');
        const btnSpeaker = document.getElementById('btn-speaker');
        const pttBtnMobile = document.getElementById('ptt-btn-mobile');
        const mainUiContainer = document.getElementById('main-ui-container');

        // --- YENÄ°: FIREBASE KÄ°MLÄ°K DOÄRULAMA (AUTH) ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                myUsername = user.displayName || user.email.split('@')[0];
                document.getElementById('auth-card').style.display = 'none';
                document.getElementById('room-controls').style.display = 'block';
                document.getElementById('display-username').innerText = myUsername;
                document.getElementById('username-input').value = myUsername; // Ä°smi varsayÄ±lan olarak ata
                document.getElementById('btn-logout').style.display = 'inline-block';
                showToast(`HoÅŸ geldin, ${myUsername}!`, 'success');
            } else {
                document.getElementById('auth-card').style.display = 'block';
                document.getElementById('room-controls').style.display = 'none';
                document.getElementById('btn-logout').style.display = 'none';
            }
        });

        document.getElementById('btn-google-login').addEventListener('click', () => {
            signInWithPopup(auth, new GoogleAuthProvider()).catch(err => showToast(err.message, 'error'));
        });

        document.getElementById('btn-email-login').addEventListener('click', () => {
            const email = document.getElementById('email-input').value;
            const pass = document.getElementById('password-input').value;
            if(!email || !pass) return showToast('E-posta ve ÅŸifre giriniz', 'error');
            
            signInWithEmailAndPassword(auth, email, pass).catch(err => {
                if(err.code === 'auth/user-not-found' || err.code === 'auth/invalid-credential') {
                    createUserWithEmailAndPassword(auth, email, pass).catch(e => showToast(e.message, 'error'));
                } else showToast('GiriÅŸ HatasÄ±: ' + err.message, 'error');
            });
        });

        document.getElementById('btn-logout').addEventListener('click', () => {
            signOut(auth);
            document.getElementById('settings-modal').classList.remove('active');
        });

        // --- YENÄ°: UÃ‡UÅAN EMOJÄ°LER (FLOATING REACTIONS) ---
        window.sendReaction = function(emoji) {
            spawnFloatingEmoji(emoji);
            stats.emojiCount++;
            const data = { type: 'REACTION', emoji: emoji };
            if (isHost) viewers.forEach(v => v.conn.send(data));
            else if (hostConnection?.open) hostConnection.send(data);
        };

        function spawnFloatingEmoji(emoji) {
            const el = document.createElement('div');
            el.className = 'floating-emoji';
            el.innerText = emoji;
            el.style.left = `${Math.random() * 80 + 10}%`; 
            document.getElementById('floating-emoji-container').appendChild(el);
            setTimeout(() => el.remove(), 2500);
        }


        // --- AYARLAR MODALI & Ä°LETÄ°ÅÄ°M MODU ---
        const settingsModal = document.getElementById('settings-modal');
        let selectedMicId = 'default', selectedSpeakerId = 'default';
        let isPttMode = false, isWhisperMode = false, isTalking = false;

        document.getElementById('btn-settings').addEventListener('click', () => settingsModal.classList.add('active'));
        document.getElementById('btn-open-login-settings').addEventListener('click', () => settingsModal.classList.add('active'));
        document.getElementById('btn-close-settings').addEventListener('click', () => settingsModal.classList.remove('active'));

        document.querySelectorAll('.avatar-option').forEach(el => {
            el.addEventListener('click', () => {
                document.querySelectorAll('.avatar-option').forEach(a => a.classList.remove('selected'));
                el.classList.add('selected'); myAvatar = el.innerText;
            });
        });

        document.getElementById('voice-mode-select').addEventListener('change', (e) => {
            isPttMode = (e.target.value === 'ptt');
            if(isPttMode && micStream) {
                micStream.getAudioTracks().forEach(t => t.enabled = false); // PTT aÃ§Ä±lÄ±nca varsayÄ±lan sessiz
                pttBtnMobile.style.display = 'flex';
                btnMic.innerHTML = "ğŸ›‘ Bas-KonuÅŸ Bekliyor";
                btnMic.style.background = "#e50914";
            } else {
                if(micStream) micStream.getAudioTracks().forEach(t => t.enabled = true);
                pttBtnMobile.style.display = 'none';
                if(micStream) { btnMic.innerHTML = "ğŸ¤ Mikrofon AÃ§Ä±k"; btnMic.style.background = "#4CAF50"; }
            }
        });

        document.getElementById('whisper-mode-toggle').addEventListener('change', (e) => isWhisperMode = e.target.checked);

        // --- SES KARIÅTIRICI VE HOPARLÃ–R ---
        document.getElementById('mix-video-vol').addEventListener('input', (e) => { videoElement.volume = e.target.value / 100; });
        document.getElementById('mix-chat-vol').addEventListener('input', (e) => {
            const vol = e.target.value / 100;
            activeAudioElements.forEach(a => { if(!a.muted) a.volume = a.dataset.whisper === 'true' ? vol * 0.3 : vol; });
        });

        let isSpeakerMuted = false;
        btnSpeaker.addEventListener('click', () => {
            isSpeakerMuted = !isSpeakerMuted;
            if (isSpeakerMuted) {
                btnSpeaker.classList.add('active'); btnSpeaker.innerHTML = "ğŸ”‡ Sohbet Sessiz";
                activeAudioElements.forEach(a => a.muted = true);
                showToast("Sohbet sesleri kapatÄ±ldÄ±.", "info");
            } else {
                btnSpeaker.classList.remove('active'); btnSpeaker.innerHTML = "ğŸ”Š Sohbet Sesi";
                activeAudioElements.forEach(a => {
                    a.muted = false;
                    const baseVol = document.getElementById('mix-chat-vol').value / 100;
                    a.volume = a.dataset.whisper === 'true' ? baseVol * 0.3 : baseVol;
                });
                showToast("Sohbet sesleri aÃ§Ä±ldÄ±.", "info");
            }
        });

        document.getElementById('btn-refresh-devices').addEventListener('click', async () => {
            try {
                await navigator.mediaDevices.getUserMedia({audio: true});
                const devices = await navigator.mediaDevices.enumerateDevices();
                const micSel = document.getElementById('mic-select'), spkSel = document.getElementById('speaker-select');
                micSel.innerHTML = '<option value="default">VarsayÄ±lan Mikrofon</option>'; spkSel.innerHTML = '<option value="default">VarsayÄ±lan HoparlÃ¶r</option>';
                devices.forEach(d => {
                    if(d.kind === 'audioinput' && d.deviceId !== 'default') micSel.innerHTML += `<option value="${d.deviceId}">${d.label || 'Mikrofon '}</option>`;
                    if(d.kind === 'audiooutput' && d.deviceId !== 'default') spkSel.innerHTML += `<option value="${d.deviceId}">${d.label || 'HoparlÃ¶r '}</option>`;
                });
                showToast("Cihazlar listelendi", "success");
            } catch(e) { showToast("Cihaz izni reddedildi!", "error"); }
        });

        document.getElementById('mic-select').addEventListener('change', (e) => selectedMicId = e.target.value);
        document.getElementById('speaker-select').addEventListener('change', (e) => {
            selectedSpeakerId = e.target.value;
            if (typeof videoElement.setSinkId !== 'undefined') {
                videoElement.setSinkId(selectedSpeakerId).catch(()=>{});
                activeAudioElements.forEach(a => a.setSinkId(selectedSpeakerId).catch(()=>{}));
            }
        });

        // --- BAS-KONUÅ (PTT) MEKANÄ°ÄÄ° ---
        function startTalking() {
            if(!isPttMode || !micStream || isTalking) return;
            isTalking = true;
            micStream.getAudioTracks().forEach(t => t.enabled = true);
            pttBtnMobile.classList.add('talking');
            btnMic.innerHTML = "ğŸ™ï¸ KonuÅŸuluyor..."; btnMic.style.background = "#4CAF50";
        }
        function stopTalking() {
            if(!isPttMode || !micStream || !isTalking) return;
            isTalking = false;
            micStream.getAudioTracks().forEach(t => t.enabled = false);
            pttBtnMobile.classList.remove('talking');
            btnMic.innerHTML = "ğŸ›‘ Bas-KonuÅŸ Bekliyor"; btnMic.style.background = "#e50914";
        }
        
        window.addEventListener('keydown', (e) => { if (e.code === 'Space' && e.target.tagName !== 'INPUT' && isPttMode && micStream) { e.preventDefault(); startTalking(); } });
        window.addEventListener('keyup', (e) => { if (e.code === 'Space' && e.target.tagName !== 'INPUT' && isPttMode) { e.preventDefault(); stopTalking(); } });
        pttBtnMobile.addEventListener('mousedown', startTalking); pttBtnMobile.addEventListener('mouseup', stopTalking); pttBtnMobile.addEventListener('mouseleave', stopTalking);
        pttBtnMobile.addEventListener('touchstart', (e) => { e.preventDefault(); startTalking(); }); pttBtnMobile.addEventListener('touchend', (e) => { e.preventDefault(); stopTalking(); });

        // --- SPOTIFY WRAPPED MEKANÄ°ÄÄ° ---
        function showWrappedAndDisconnect() {
            if (!stats.startTime) return executeDisconnect(); 
            
            const durationMins = Math.max(1, Math.floor((Date.now() - stats.startTime) / 60000));
            let topChatter = "Kimse", maxMsgs = 0;
            for(const [usr, count] of Object.entries(stats.userMsgCounts)) { if(count > maxMsgs && usr !== "Sistem") { maxMsgs = count; topChatter = usr; } }

            document.getElementById('w-stat-time').innerText = durationMins;
            document.getElementById('w-stat-msg').innerText = stats.myMsgCount;
            document.getElementById('w-stat-top').innerText = topChatter;
            document.getElementById('w-stat-emoji').innerText = stats.emojiCount;
            
            const wContainer = document.getElementById('wrapped-overlay');
            wContainer.style.display = 'flex';
            
            const slides = document.querySelectorAll('.w-slide');
            slides.forEach(s => s.classList.remove('show'));
            
            let delay = 0;
            slides.forEach((slide, idx) => {
                setTimeout(() => {
                    if(idx > 0) slides[idx-1].classList.remove('show');
                    slide.classList.add('show');
                }, delay);
                delay += 3000; 
            });

            setTimeout(() => {
                wContainer.style.display = 'none';
                executeDisconnect();
            }, delay + 1000);
        }

        // --- GÃ–RÃœNÃœM MODLARI ---
        let isTheaterMode = false;
        document.getElementById('btn-theater').addEventListener('click', () => {
            isTheaterMode = !isTheaterMode;
            if(isTheaterMode) { mainUiContainer.classList.add('theater-mode'); showToast("Sohbet gizlendi.", "info"); } 
            else mainUiContainer.classList.remove('theater-mode');
        });

        document.getElementById('btn-pip').addEventListener('click', async () => {
            try { if (document.pictureInPictureElement) await document.exitPictureInPicture(); else await videoElement.requestPictureInPicture(); } 
            catch (err) { showToast("CihazÄ±nÄ±z PiP desteklemiyor.", "error"); }
        });

        let isCinemaMode = false;
        function toggleCinemaMode() {
            isCinemaMode = !isCinemaMode;
            if (isCinemaMode) { document.body.classList.add('cinema-mode'); showToast("Sinema Modu Aktif", "info"); } 
            else document.body.classList.remove('cinema-mode');
        }
        document.getElementById('btn-cinema').addEventListener('click', toggleCinemaMode);
        document.getElementById('btn-cinema-exit').addEventListener('click', toggleCinemaMode);

        // --- ARAYÃœZ FONKSÄ°YONLARI ---
        function switchScreen(room, role) {
            document.getElementById('room-display').innerText = room;
            document.getElementById('role-display').innerText = role;
            document.getElementById('login-screen').classList.remove('active');
            document.getElementById('video-screen').classList.add('active');
            chatMessages.innerHTML = ''; 
            addChatMessage("Sistem", "ğŸ’»", "Odaya katÄ±ldÄ±nÄ±z. Ä°yi seyirler!", false);
            stats = { startTime: Date.now(), myMsgCount: 0, totalMsgCount: 0, emojiCount: 0, userMsgCounts: {} };
        }

        function addChatMessage(sender, avatar, text, isMe) {
            const div = document.createElement('div');
            div.className = `message ${isMe ? 'me' : ''}`;
            div.innerHTML = `<div class="sender-info"><span class="msg-avatar">${avatar}</span> ${sender}</div><div class="msg-text">${text}</div>`;
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight; 
            
            stats.totalMsgCount++;
            if (isMe) stats.myMsgCount++;
            stats.userMsgCounts[sender] = (stats.userMsgCounts[sender] || 0) + 1;
            const emojiMatch = text.match(/\p{Emoji}/gu);
            if(emojiMatch) stats.emojiCount += emojiMatch.length;
        }

        function executeDisconnect() {
            // YENÄ°: Firebase'den odayÄ± temizle
            if (isHost && roomCode) { remove(ref(database, 'rooms/' + roomCode)); }

            if (myStream) myStream.getTracks().forEach(t => t.stop());
            if (micStream) micStream.getTracks().forEach(t => t.stop());
            if (peer) peer.destroy();
            viewers.clear(); activeVoiceCalls.clear();
            activeAudioElements.forEach(a => a.remove()); activeAudioElements = [];
            videoElement.srcObject = null;
            
            document.getElementById('video-screen').classList.remove('active');
            document.getElementById('login-screen').classList.add('active');
            document.body.classList.remove('cinema-mode');
            mainUiContainer.classList.remove('theater-mode');
            
            btnMic.classList.remove('active'); btnMic.innerHTML = "ğŸ¤ Mikrofon"; btnMic.style.background = "#444";
            btnSpeaker.classList.remove('active'); btnSpeaker.innerHTML = "ğŸ”Š Sohbet Sesi";
            pttBtnMobile.style.display = 'none';
            isSpeakerMuted = false;
        }

        document.getElementById('leave-btn').addEventListener('click', () => {
            if (confirm("Odadan ayrÄ±lmak istediÄŸinize emin misiniz?")) showWrappedAndDisconnect();
        });

        // --- YENÄ°: MEKANSAL SES (SPATIAL AUDIO) MANTIÄI EKLENDÄ° ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function handleIncomingVoice(call) {
            call.answer();
            call.on('stream', audioStream => {
                if (audioCtx.state === 'suspended') audioCtx.resume();
                
                // 3D Ses Ä°ÅŸleme AÅŸamasÄ±
                const source = audioCtx.createMediaStreamSource(audioStream);
                const panner = audioCtx.createStereoPanner();
                panner.pan.value = (Math.random() * 2) - 1; // Her kiÅŸiye -1 (Sol) ile +1 (SaÄŸ) arasÄ± rastgele konum
                const destination = audioCtx.createMediaStreamDestination();
                
                source.connect(panner);
                panner.connect(destination);

                // Orijinal Ses Ã‡Ä±ktÄ±sÄ± MantÄ±ÄŸÄ± (AyarlarÄ± ve CihazlarÄ± korumak iÃ§in)
                const audio = document.createElement('audio');
                audio.srcObject = destination.stream; // Ä°ÅŸlenmiÅŸ 3D sesi oynatÄ±cÄ±ya ver
                audio.autoplay = true;
                audio.muted = isSpeakerMuted; 
                
                const isWhisper = call.metadata?.whisper;
                audio.dataset.whisper = isWhisper ? 'true' : 'false';
                
                if(typeof audio.setSinkId !== 'undefined' && selectedSpeakerId !== 'default') audio.setSinkId(selectedSpeakerId).catch(()=>{});
                const baseVol = document.getElementById('mix-chat-vol').value / 100;
                audio.volume = isWhisper ? baseVol * 0.3 : baseVol;
                
                document.body.appendChild(audio);
                activeAudioElements.push(audio);
                call.on('close', () => { audio.remove(); activeAudioElements = activeAudioElements.filter(a => a !== audio); });
            });
        }

        // SES BAÄLANTISI (AynÄ± KaldÄ±)
        btnMic.addEventListener('click', async () => {
            if (micStream) {
                micStream.getTracks().forEach(t => t.stop()); micStream = null;
                btnMic.classList.remove('active'); btnMic.innerHTML = "ğŸ¤ Mikrofon"; btnMic.style.background = "#444";
                activeVoiceCalls.forEach(call => call.close()); activeVoiceCalls.clear();
                pttBtnMobile.style.display = 'none';
                showToast("Mikrofon kapatÄ±ldÄ±.", "info");
            } else {
                try {
                    const constraints = { audio: selectedMicId !== 'default' ? { deviceId: { exact: selectedMicId } } : true };
                    micStream = await navigator.mediaDevices.getUserMedia(constraints);
                    
                    if(isPttMode) {
                        micStream.getAudioTracks().forEach(t => t.enabled = false);
                        btnMic.innerHTML = "ğŸ›‘ Bas-KonuÅŸ Bekliyor"; btnMic.style.background = "#e50914";
                        pttBtnMobile.style.display = 'flex';
                    } else {
                        btnMic.classList.add('active'); btnMic.innerHTML = "ğŸ¤ Mikrofon AÃ§Ä±k"; btnMic.style.background = "";
                    }
                    showToast("Sese baÄŸlanÄ±ldÄ±!", "success");
                    
                    const voiceMeta = { type: 'voice', whisper: isWhisperMode };
                    if (isHost) {
                        viewers.forEach((v, pId) => { const call = peer.call(pId, micStream, { metadata: voiceMeta }); activeVoiceCalls.set(pId, call); });
                    } else {
                        const call = peer.call(hostId, micStream, { metadata: voiceMeta }); activeVoiceCalls.set(hostId, call);
                    }
                } catch (e) { showToast("Mikrofon eriÅŸimi reddedildi!", "error"); }
            }
        });

        // --- YAYINCI (HOST) MANTIÄI (YENÄ°: Firebase DB Entegrasyonu) ---
        document.getElementById('btn-host').addEventListener('click', async () => {
            roomCode = document.getElementById('room-input').value.trim();
            myUsername = document.getElementById('username-input').value.trim() || "YayÄ±ncÄ±";
            if(!roomCode) return showToast("LÃ¼tfen Oda Kodu girin!", "error");

            try {
                myStream = await navigator.mediaDevices.getDisplayMedia({ video: { cursor: "never" }, audio: true });
            } catch (err) {
                try {
                    myStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: false });
                    showToast("Sistem sesi aktarÄ±lamÄ±yor, sessiz yayÄ±n baÅŸladÄ±.", "info");
                } catch (mobileErr) { return showToast("Cihaz ekran paylaÅŸÄ±mÄ±nÄ± desteklemiyor!", "error"); }
            }

            videoElement.srcObject = myStream;
            videoElement.muted = true; 
            isHost = true;
            document.getElementById('admin-panel').style.display = 'block'; 

            peer = new Peer(); // SinyalleÅŸme iÃ§in rastgele ID oluÅŸturur (GeliÅŸtirilmiÅŸ GÃ¼venlik)
            peer.on('open', (id) => { 
                hostId = id;
                
                // OdayÄ± Firebase VeritabanÄ±na Yaz
                set(ref(database, 'rooms/' + roomCode), {
                    hostId: hostId,
                    hostName: myUsername,
                    createdAt: serverTimestamp()
                });

                statusText.innerText = "YayÄ±n Aktif!"; switchScreen(roomCode, "YayÄ±ncÄ±"); showToast("Oda baÅŸarÄ±yla kuruldu.", "success"); 
            });

            peer.on('call', call => { if (call.metadata?.type === 'voice') handleIncomingVoice(call); });

            peer.on('connection', conn => {
                conn.on('open', () => {
                    const uname = conn.metadata?.username || "Anonim", uavatar = conn.metadata?.avatar || "ğŸ‘¤";
                    viewers.set(conn.peer, { conn: conn, username: uname, avatar: uavatar });
                    updateAdminPanel();
                    showToast(`${uname} odaya katÄ±ldÄ±!`, "success");

                    if (myStream) peer.call(conn.peer, myStream, { metadata: { type: 'screen' } });
                    if (micStream) { const vCall = peer.call(conn.peer, micStream, { metadata: { type: 'voice', whisper: isWhisperMode } }); activeVoiceCalls.set(conn.peer, vCall); }
                });

                conn.on('data', data => {
                    if (data.type === 'CHAT') {
                        addChatMessage(data.sender, data.avatar, data.text, false);
                        viewers.forEach(v => { if (v.conn.peer !== conn.peer) v.conn.send(data); });
                    }
                    else if (data.type === 'REACTION') { // Reaksiyon DaÄŸÄ±tÄ±cÄ±
                        spawnFloatingEmoji(data.emoji);
                        viewers.forEach(v => { if (v.conn.peer !== conn.peer) v.conn.send(data); });
                    }
                });
                conn.on('close', () => { 
                    const vData = viewers.get(conn.peer); if(vData) showToast(`${vData.username} odadan ayrÄ±ldÄ±.`, "info");
                    viewers.delete(conn.peer); updateAdminPanel(); 
                });
            });

            myStream.getVideoTracks()[0].onended = () => { showToast("PaylaÅŸÄ±m durduruldu.", "error"); showWrappedAndDisconnect(); };
        });

        // --- Ä°ZLEYÄ°CÄ° (VIEWER) MANTIÄI (YENÄ°: Firebase DB Entegrasyonu) ---
        document.getElementById('btn-viewer').addEventListener('click', () => {
            roomCode = document.getElementById('room-input').value.trim();
            myUsername = document.getElementById('username-input').value.trim() || "Ä°zleyici";
            if(!roomCode) return showToast("LÃ¼tfen Oda Kodu girin!", "error");

            isHost = false;
            document.getElementById('admin-panel').style.display = 'none';

            // Firebase'den GerÃ§ek Oda ID'sini Ã–ÄŸren
            get(ref(database, 'rooms/' + roomCode)).then((snapshot) => {
                if(!snapshot.exists()) return showToast("BÃ¶yle bir oda bulunamadÄ±!", "error");
                
                hostId = snapshot.val().hostId;
                
                peer = new Peer(); 
                peer.on('open', () => {
                    statusText.innerText = "YayÄ±ncÄ± aranÄ±yor...";
                    switchScreen(roomCode, "Ä°zleyici");

                    hostConnection = peer.connect(hostId, { metadata: { username: myUsername, avatar: myAvatar } });
                    hostConnection.on('open', () => { statusText.innerText = "GÃ¶rÃ¼ntÃ¼ bekleniyor..."; showToast("YayÄ±ncÄ±ya baÄŸlanÄ±ldÄ±!", "success"); });

                    hostConnection.on('data', data => {
                        if (data.type === 'CHAT') addChatMessage(data.sender, data.avatar, data.text, false);
                        else if (data.type === 'REACTION') spawnFloatingEmoji(data.emoji);
                        else if (data.type === 'CLEAR_CHAT') { chatMessages.innerHTML = ''; showToast("Sohbet temizlendi.", "info"); }
                        else if (data.type === 'KICK') { showToast("Odadan atÄ±ldÄ±nÄ±z!", "error"); setTimeout(showWrappedAndDisconnect, 1000); }
                    });

                    peer.on('call', call => {
                        if (call.metadata?.type === 'screen') {
                            call.answer(); 
                            call.on('stream', rStream => {
                                videoElement.srcObject = rStream; statusText.innerText = "BaÄŸlÄ±";
                                videoElement.onloadedmetadata = () => videoElement.play().catch(() => playOverlay.style.display = 'flex');
                            });
                        } else if (call.metadata?.type === 'voice') { handleIncomingVoice(call); }
                    });

                    peer.on('error', err => { if (err.type === 'peer-unavailable') { showToast("YayÄ±ncÄ±ya ulaÅŸÄ±lamÄ±yor!", "error"); setTimeout(executeDisconnect, 2000); } });
                });
            }).catch(error => showToast("Oda kontrol edilemedi.", "error"));
        });

        document.getElementById('force-play-btn').addEventListener('click', () => { playOverlay.style.display = 'none'; videoElement.play(); });

        // --- SOHBET ---
        function sendMessage() {
            const text = chatInput.value.trim();
            if(!text) return;
            const msgData = { type: 'CHAT', sender: myUsername, avatar: myAvatar, text: text };
            if(isHost) { viewers.forEach(v => v.conn.send(msgData)); addChatMessage(myUsername, myAvatar, text, true); } 
            else { if(hostConnection?.open) { hostConnection.send(msgData); addChatMessage(myUsername, myAvatar, text, true); } else showToast("BaÄŸlantÄ± yok.", "error"); }
            chatInput.value = '';
        }

        document.getElementById('chat-send-btn').addEventListener('click', sendMessage);
        document.getElementById('chat-input').addEventListener('keypress', (e) => { if(e.key === 'Enter') sendMessage(); });

        // --- ADMÄ°N (Host) ---
        function updateAdminPanel() {
            const list = document.getElementById('admin-user-list');
            list.innerHTML = '';
            viewers.forEach((v, peerId) => {
                const li = document.createElement('li'); li.className = 'admin-user-item';
                li.innerHTML = `<span>${v.avatar} ${v.username}</span> <button class="kick-btn" onclick="window.kickUser('${peerId}')">At</button>`;
                list.appendChild(li);
            });
        }
        window.kickUser = function(pId) { const t = viewers.get(pId); if(t && confirm(`${t.username} atÄ±lsÄ±n mÄ±?`)) { t.conn.send({ type: 'KICK' }); setTimeout(() => t.conn.close(), 500); } };
        document.getElementById('btn-clear-chat').addEventListener('click', () => {
            if(confirm("Sohbeti herkes iÃ§in sil?")) { chatMessages.innerHTML = ''; viewers.forEach(v => v.conn.send({ type: 'CLEAR_CHAT' })); showToast("Sohbet temizlendi.", "info"); }
        });
    </script>
</body>
</html>